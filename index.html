<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Procedure Established by Law | PEBL Tracker</title>
    
    <style>
        /* --- DESIGN & FONTS --- */
        body { font-family: "Georgia", serif; background: #f8f9fa; margin: 0; padding: 40px 20px; color: #333; }
        .container { max-width: 950px; margin: 0 auto; }
        
        /* HEADER */
        header { text-align: center; margin-bottom: 40px; border-bottom: 2px solid #2c3e50; padding-bottom: 30px; }
        h1 { margin: 0; color: #2c3e50; font-size: 2.5rem; letter-spacing: -1px; }
        p.subtitle { color: #555; font-size: 1.1rem; margin-top: 10px; font-style: italic; font-family: sans-serif; }

        /* MAP CONTAINER */
        .map-wrapper {
            position: relative;
            width: 100%;
            max-width: 650px; /* Controls Map Size */
            margin: 0 auto 30px auto;
        }

        /* SVG STYLING */
        svg { width: 100%; height: auto; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); }
        
        /* State Styling */
        path { 
            cursor: pointer; 
            transition: all 0.2s; 
            fill: #6f9c76; /* Default Green */
        }
        path:hover { 
            fill: #2c3e50 !important; /* Dark Blue on Hover */
            stroke: #fff;
            stroke-width: 2;
        }
        /* Hide the little city dots in the SVG */
        circle { display: none; }

        /* SUPREME COURT BUTTON (Floating) */
        .sc-btn {
            display: block;
            width: 220px;
            margin: 0 auto 40px auto;
            background: #c0392b;
            color: white;
            text-align: center;
            padding: 12px 20px;
            border-radius: 50px;
            text-decoration: none;
            font-family: sans-serif;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: transform 0.2s;
        }
        .sc-btn:hover { transform: scale(1.05); background: #a93226; }

        /* FILTER TAG */
        #filter-display { text-align: center; margin-bottom: 20px; min-height: 30px; }
        .filter-tag { display: inline-block; background: #2c3e50; color: white; padding: 5px 15px; border-radius: 20px; font-family: sans-serif; font-size: 0.9rem; cursor: pointer; }
        .filter-tag:hover { background: #c0392b; }

        /* CARDS */
        .case-grid { display: grid; gap: 20px; }
        .card { background: white; padding: 25px; border: 1px solid #e0e0e0; border-left: 5px solid #2c3e50; font-family: sans-serif; }
        .card h3 { margin: 0 0 5px 0; color: #2c3e50; }
        .court-label { float: right; font-size: 0.8rem; color: #7f8c8d; text-transform: uppercase; letter-spacing: 1px; font-weight: bold; }
        .citation { font-family: serif; color: #666; font-style: italic; display: block; margin-bottom: 15px; }
        .summary { line-height: 1.6; color: #444; margin-bottom: 15px; }
        .tag { background: #ecf0f1; padding: 3px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; color: #555; }
        .read-btn { text-decoration: none; color: #2980b9; font-weight: bold; border-bottom: 2px solid transparent; }
        .read-btn:hover { border-bottom-color: #2980b9; }

        #loading { text-align: center; color: #888; font-family: sans-serif; margin-top: 30px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Procedure Established by Law</h1>
        <p class="subtitle">An audit of Article 21 jurisprudence.</p>
    </header>

    <!-- 1. THE MAP -->
    <div class="map-wrapper" id="map-container">
        <!-- SVG will be injected here by JavaScript -->
    </div>
    
    <!-- 2. SUPREME COURT BUTTON -->
    <div class="sc-btn" onclick="filterByState('Pan-India')">
        ★ Supreme Court Cases
    </div>

    <!-- 3. FILTER STATUS -->
    <div id="filter-display"></div>

    <!-- 4. CASE LIST -->
    <div id="loading">Loading Database...</div>
    <div class="case-grid" id="case-list"></div>
</div>

<script>
    // --- CONFIGURATION ---
    const SHEET_ID = '1k3O3nEbs24UXsoAsrNPmaZfBvpAJCmaEzypuQTD-yuY'; // <--- PASTE ID HERE
    const SHEET_NAME = 'Sheet1';
    // ---------------------

    let allCases = [];

    // --- STEP A: LOAD THE MAP ---
    fetch('india.svg')
        .then(response => response.text())
        .then(svgData => {
            const mapContainer = document.getElementById('map-container');
            mapContainer.innerHTML = svgData;
            
            // Add click listeners to every state path
            const paths = mapContainer.querySelectorAll('path');
            paths.forEach(path => {
                path.addEventListener('click', function() {
                    // This SVG has the name built in! (e.g., name="Kerala")
                    const stateName = this.getAttribute('name');
                    if(stateName) {
                        handleMapClick(stateName);
                    }
                });
            });
        })
        .catch(err => console.error("Error loading map:", err));


    // --- STEP B: LOAD DATA FROM GOOGLE SHEETS ---
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${SHEET_NAME}`;
    
    fetch(url)
        .then(r => r.text())
        .then(csvText => {
            const rows = csvToArray(csvText);
            allCases = rows.slice(1).map(row => ({
                name: clean(row[0]),
                citation: clean(row[1]),
                court: clean(row[2]),
                state: clean(row[3]) || "Pan-India",
                right: clean(row[4]),
                summary: clean(row[5]),
                link: clean(row[6]) || "#"
            })).filter(c => c.name && c.name !== "Case Name");

            document.getElementById('loading').style.display = 'none';
            renderCases(allCases); // Show all initially
        });

    // --- HELPER FUNCTIONS ---

    function handleMapClick(stateName) {
        document.getElementById('filter-display').innerHTML = 
            `<span class="filter-tag" onclick="resetFilter()">Showing: ${stateName} ✕</span>`;
        filterByState(stateName);
        
        // Scroll down slightly to show results
        document.getElementById('filter-display').scrollIntoView({behavior: "smooth"});
    }

    function filterByState(stateName) {
        // Filter logic: Match state name exactly
        const filtered = allCases.filter(c => c.state === stateName);
        renderCases(filtered);
    }

    function resetFilter() {
        document.getElementById('filter-display').innerHTML = '';
        renderCases(allCases);
    }

    function renderCases(cases) {
        const list = document.getElementById('case-list');
        list.innerHTML = '';
        if(cases.length === 0) {
            list.innerHTML = '<p style="text-align:center">No cases found for this jurisdiction.</p>';
            return;
        }
        
        cases.forEach(item => {
            list.innerHTML += `
                <div class="card">
                    <span class="court-label">${item.court}</span>
                    <h3>${item.name}</h3>
                    <span class="citation">${item.citation}</span>
                    <span class="tag">${item.right}</span>
                    <p class="summary">${item.summary}</p>
                    <a href="${item.link}" target="_blank" class="read-btn">Read Analysis →</a>
                </div>`;
        });
    }

    // CSV Parsing Utilities
    function clean(text) { return text ? text.replace(/^"|"$/g, '').replace(/""/g, '"') : ""; }
    function csvToArray(str) {
        const rows = []; let currentRow = []; let currentCell = ""; let inQuotes = false;
        for (let i = 0; i < str.length; i++) {
            const char = str[i];
            if (char === '"') { inQuotes = !inQuotes; }
            else if (char === ',' && !inQuotes) { currentRow.push(currentCell); currentCell = ""; }
            else if (char === '\n' && !inQuotes) { currentRow.push(currentCell); rows.push(currentRow); currentRow = []; currentCell = ""; }
            else { currentCell += char; }
        }
        return rows;
    }
</script>

</body>
</html>
