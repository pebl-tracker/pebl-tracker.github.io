<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- SEO Meta Tags -->
    <meta name="description" content="An audit of Article 21 jurisprudence. Tracking the shift from Constitutional Interpretation to Judicial Legislation.">
    <meta name="keywords" content="Article 21, India, Constitution, Supreme Court, PEBL, Unenumerated Rights">
    <title>Procedure Established by Law | PEBL Tracker</title>
    
    <style>
        /* --- CORE STYLES --- */
        :root { --primary: #2c3e50; --accent: #c0392b; --bg: #f8f9fa; }
        body { font-family: "Georgia", serif; background: var(--bg); margin: 0; padding: 0; color: #333; }
        .container { max-width: 950px; margin: 0 auto; padding: 40px 20px; }
        
        //* HEADER STYLES */
        header { 
            text-align: center; 
            margin-bottom: 30px; 
            border-bottom: 2px solid var(--primary); 
            padding-bottom: 30px; 
            position: relative; /* This allows us to position the curator text */
        }
        header a { text-decoration: none; color: inherit; }
        
        /* The Curator Signature */
        .curator-tag {
            position: absolute;
            bottom: 0;       /* Sits exactly on the bottom padding line */
            right: 0;        /* Aligns to the right */
            font-family: sans-serif;
            font-size: 0.85rem;
            color: #7f8c8d;
            background: var(--bg); /* Matches background to look clean */
            padding-left: 10px;    /* Adds a little breathing room */
            line-height: 1;
            margin-bottom: 5px;    /* Nudges it slightly up to rest on the border */
        }
        /* --- NAVIGATION / SEARCH BAR --- */
        .controls-bar {
            display: flex; gap: 10px; margin-bottom: 30px;
            background: white; padding: 15px; border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            font-family: sans-serif; flex-wrap: wrap;
        }
        #search-input {
            flex-grow: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; min-width: 200px;
        }
        .filter-select {
            padding: 10px; border: 1px solid #ddd; border-radius: 4px; min-width: 140px; cursor: pointer; background: white;
        }

        /* --- MAP SECTION --- */
        .map-wrapper {
            position: relative; width: 100%; max-width: 650px;
            margin: 0 auto 30px auto;
        }
        svg { width: 100%; height: auto; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); }
        path { cursor: pointer; transition: all 0.2s; fill: #6f9c76; stroke: #ffffff; stroke-width: 0.5; }
        path:hover { fill: var(--primary) !important; stroke: #fff; stroke-width: 2; }
        circle { display: none; }

        /* SC BUTTON */
        .sc-btn {
            display: block; width: 220px; margin: 0 auto 40px auto;
            background: var(--accent); color: white; text-align: center;
            padding: 12px 20px; border-radius: 50px; text-decoration: none;
            font-family: sans-serif; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2); transition: transform 0.2s;
        }
        .sc-btn:hover { transform: scale(1.05); background: #a93226; }

        /* FILTER TAGS */
        #filter-display { text-align: center; margin-bottom: 20px; min-height: 30px; }
        .filter-tag { 
            display: inline-block; background: var(--primary); color: white; 
            padding: 5px 15px; border-radius: 20px; font-family: sans-serif; 
            font-size: 0.9rem; cursor: pointer; 
        }
        .filter-tag:hover { background: var(--accent); }

        /* --- CARD GRID --- */
        .case-grid { display: grid; gap: 20px; }
        .card { 
            background: white; padding: 25px; border: 1px solid #e0e0e0; 
            border-left: 5px solid var(--primary); font-family: sans-serif; 
            transition: transform 0.2s;
        }
        .card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .card-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 5px; }
        .card h3 { margin: 0; color: var(--primary); font-size: 1.4rem; }
        
        .court-label { font-size: 0.8rem; color: #7f8c8d; text-transform: uppercase; letter-spacing: 1px; font-weight: bold; display: block; margin-bottom: 5px;}
        .citation { font-family: serif; color: #666; font-style: italic; display: block; margin-bottom: 15px; }
        .tag { background: #ecf0f1; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; color: #555; display: inline-block; margin-right: 5px; margin-bottom: 10px;}
        .summary-preview { color: #555; line-height: 1.5; margin-bottom: 15px; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        
        .action-link { 
            color: var(--primary); font-weight: bold; text-decoration: none; 
            border-bottom: 2px solid var(--primary); cursor: pointer;
        }
        .action-link:hover { color: var(--accent); border-color: var(--accent); }

        /* --- DETAILS VIEW --- */
        #details-view { display: none; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .back-btn { display: inline-block; margin-bottom: 20px; cursor: pointer; color: #666; font-family: sans-serif; }
        .back-btn:hover { color: var(--primary); text-decoration: underline; }
        .details-meta { border-bottom: 1px solid #eee; padding-bottom: 20px; margin-bottom: 20px; }
        .details-body { font-size: 1.1rem; line-height: 1.8; white-space: pre-wrap; }
        .external-btn { display: inline-block; margin-top: 30px; background: var(--primary); color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px; font-family: sans-serif; }

        #loading { text-align: center; color: #888; font-family: sans-serif; margin-top: 30px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <a href=".">
            <h1>Procedure Established by Law</h1>
        </a>
        <p class="subtitle">Tracking the Reading of Unenumerated Rights into Article 21</p>
        
        <!-- The Curator Name -->
        <div class="curator-tag">Curator: Abhinav Somani</div>
    </header>

    <!-- === MAIN VIEW === -->
    <div id="main-view">
        <!-- 1. MAP -->
        <div class="map-wrapper" id="map-container"></div>
        <div class="sc-btn" onclick="handleMapClick('Pan-India')">★ Supreme Court</div>

        <!-- 2. SEARCH & CONTROLS -->
        <div class="controls-bar">
            <input type="text" id="search-input" placeholder="Search cases (e.g. Maneka Gandhi)..." onkeyup="handleSearch()">
            
            <!-- Sort Filter (Newest/Oldest) -->
            <select id="sort-order" class="filter-select" onchange="handleSearch()">
                <option value="newest">Newest First</option>
                <option value="oldest">Oldest First</option>
            </select>

            <!-- Rights Filter -->
            <select id="right-filter" class="filter-select" onchange="handleSearch()">
                <option value="">All Rights</option>
            </select>
        </div>

        <!-- 3. FILTER STATUS -->
        <div id="filter-display"></div>

        <!-- 4. CASE LIST -->
        <div id="loading">Loading Database...</div>
        <div class="case-grid" id="case-list"></div>
    </div>

    <!-- === DETAILS VIEW === -->
    <div id="details-view">
        <div class="back-btn" onclick="closeDetails()">← Back to Tracker</div>
        <div class="details-meta">
            <h2 id="detail-title" style="margin-top:0; color: var(--primary);">Case Name</h2>
            <div style="color: #666; font-family: serif; font-style: italic;" id="detail-citation">Citation</div>
            <div style="margin-top: 10px;">
                <span class="tag" id="detail-court">Court</span>
                <span id="detail-rights-container"></span>
                <span class="tag" id="detail-date" style="background:#eee;">Date</span>
            </div>
        </div>
        <div class="details-body" id="detail-summary"></div>
        <a href="#" target="_blank" class="external-btn" id="detail-link">Read Full Judgement →</a>
    </div>

</div>

<script>
    // --- CONFIGURATION ---
    const SHEET_ID = '1k3O3nEbs24UXsoAsrNPmaZfBvpAJCmaEzypuQTD-yuY'; // YOUR SHEET ID
    const SHEET_NAME = 'Sheet1';
    // ---------------------

    let allCases = [];
    let currentFilterState = null;

    // --- INITIALIZATION ---
    fetch('india.svg')
        .then(response => response.text())
        .then(svgData => {
            const mapContainer = document.getElementById('map-container');
            mapContainer.innerHTML = svgData;
            const paths = mapContainer.querySelectorAll('path');
            paths.forEach(path => {
                path.addEventListener('click', function() {
                    const stateName = this.getAttribute('name');
                    if(stateName) handleMapClick(stateName);
                });
            });
        });

    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${SHEET_NAME}`;
    
    fetch(url)
        .then(r => r.text())
        .then(csvText => {
            const rows = csvToArray(csvText);
            
            // Map Columns: Name[0], Citation[1], Court[2], State[3], Right[4], Summary[5], Link[6], Date[7]
            allCases = rows.slice(1).map(row => ({
                name: clean(row[0]),
                citation: clean(row[1]),
                court: clean(row[2]),
                state: clean(row[3]) || "Pan-India",
                rights: clean(row[4]).split(',').map(r => r.trim()).filter(r => r), // Handle Multiple Rights
                summary: clean(row[5]),
                link: clean(row[6]) || "#",
                date: clean(row[7]) // Column H
            })).filter(c => c.name && c.name !== "Case Name");

            document.getElementById('loading').style.display = 'none';
            populateDropdown();
            generateHeatmap(allCases);
            checkUrlParams();
        });

    // --- SEARCH & FILTER LOGIC ---

    function handleSearch() {
        const query = document.getElementById('search-input').value.toLowerCase();
        const rightFilter = document.getElementById('right-filter').value;
        const sortOrder = document.getElementById('sort-order').value;

        // 1. Filter by Map State (if any)
        let filtered = currentFilterState ? allCases.filter(c => c.state === currentFilterState) : allCases;

        // 2. Filter by Search & Right
        filtered = filtered.filter(c => {
            const matchesSearch = c.name.toLowerCase().includes(query) || c.summary.toLowerCase().includes(query);
            const matchesRight = rightFilter ? c.rights.includes(rightFilter) : true;
            return matchesSearch && matchesRight;
        });

        // 3. Sort by Date
        filtered.sort((a, b) => {
            const dateA = parseIndianDate(a.date);
            const dateB = parseIndianDate(b.date);
            return sortOrder === 'newest' ? dateB - dateA : dateA - dateB;
        });

        renderCases(filtered);
    }

    function renderCases(cases) {
        const list = document.getElementById('case-list');
        list.innerHTML = '';
        if(cases.length === 0) {
            list.innerHTML = '<p style="text-align:center">No cases found matching criteria.</p>';
            return;
        }
        
        cases.forEach(item => {
            const urlSafeName = encodeURIComponent(item.name);
            let displayDate = item.date;
            try {
                const d = parseIndianDate(item.date);
                if(d.getFullYear() > 1900) {
                    displayDate = d.toLocaleDateString('en-GB', { year: 'numeric', month: 'short', day: 'numeric' });
                }
            } catch(e) {}

            const tagsHtml = item.rights.map(r => `<span class="tag">${r}</span>`).join(' ');

            list.innerHTML += `
                <div class="card">
                    <span class="court-label">${item.court}</span>
                    <div class="card-header">
                        <h3>${item.name}</h3>
                    </div>
                    <div style="font-size:0.85rem; color:#888; margin-bottom:8px;">${displayDate || ""}</div>
                    <span class="citation">${item.citation}</span>
                    <div>${tagsHtml}</div>
                    <div class="summary-preview">${item.summary}</div>
                    <a class="action-link" onclick="openDetails('${urlSafeName}')">Read More →</a>
                </div>`;
        });
    }

    // --- UTILS ---
    function handleMapClick(stateName) {
        currentFilterState = stateName;
        document.getElementById('filter-display').innerHTML = `<span class="filter-tag" onclick="resetFilter()">Showing: ${stateName} ✕</span>`;
        document.getElementById('search-input').value = "";
        handleSearch();
        document.getElementById('search-input').scrollIntoView({behavior: "smooth", block: "start"});
    }

    function resetFilter() {
        currentFilterState = null;
        document.getElementById('filter-display').innerHTML = '';
        handleSearch();
    }

    function populateDropdown() {
        const allRights = allCases.flatMap(c => c.rights);
        const uniqueRights = [...new Set(allRights)].sort();
        const select = document.getElementById('right-filter');
        uniqueRights.forEach(r => {
            if(r) {
                const opt = document.createElement('option');
                opt.value = r; opt.innerText = r;
                select.appendChild(opt);
            }
        });
    }

    // --- DATE PARSER (DD-MM-YYYY) ---
    function parseIndianDate(dateStr) {
        if (!dateStr) return new Date(0); 
        const parts = dateStr.split(/[-/.]/); 
        if (parts.length === 3) return new Date(parts[2], parts[1] - 1, parts[0]);
        return new Date(dateStr); 
    }

    // --- DETAILS PAGE ---
    function openDetails(encodedName) {
        const caseName = decodeURIComponent(encodedName);
        const item = allCases.find(c => c.name === caseName);
        if(!item) return;

        const newUrl = window.location.pathname + '?case=' + encodedName;
        window.history.pushState({path: newUrl}, '', newUrl);

        document.getElementById('detail-title').innerText = item.name;
        document.getElementById('detail-citation').innerText = item.citation;
        document.getElementById('detail-court').innerText = item.court;
        
        const rightsHtml = item.rights.map(r => `<span class="tag">${r}</span>`).join(' ');
        document.getElementById('detail-rights-container').innerHTML = rightsHtml;

        document.getElementById('detail-date').innerText = item.date || "Date N/A";
        document.getElementById('detail-summary').innerText = item.summary;
        document.getElementById('detail-link').href = item.link;

        document.getElementById('main-view').classList.add('hidden');
        document.getElementById('details-view').style.display = 'block';
        window.scrollTo(0,0);
    }

    function closeDetails() {
        window.history.pushState({}, document.title, window.location.pathname);
        document.getElementById('details-view').style.display = 'none';
        document.getElementById('main-view').classList.remove('hidden');
    }

    function checkUrlParams() {
        const urlParams = new URLSearchParams(window.location.search);
        const caseParam = urlParams.get('case');
        if(caseParam) openDetails(caseParam);
        else handleSearch(); 
    }

    function generateHeatmap(cases) {
        const counts = {};
        let maxCount = 0;
        cases.forEach(c => {
            const s = c.state ? c.state.trim() : "";
            if(s) {
                counts[s] = (counts[s] || 0) + 1;
                if(s !== "Pan-India" && counts[s] > maxCount) maxCount = counts[s];
            }
        });

        const paths = document.querySelectorAll('path');
        paths.forEach(p => {
            const stateName = p.getAttribute('name');
            const count = counts[stateName] || 0;
            const label = `${stateName}: ${count} Case${count !== 1 ? 's' : ''}`;
            
            let titleEl = p.querySelector('title');
            if (!titleEl) {
                titleEl = document.createElementNS("http://www.w3.org/2000/svg", "title");
                p.appendChild(titleEl);
            }
            titleEl.textContent = label;
            p.setAttribute('title', label); 

            if (count > 0) {
                const intensity = 0.3 + (0.7 * (count / maxCount));
                p.style.fill = `rgba(44, 62, 80, ${intensity})`;
            } else { p.style.fill = '#e0e0e0'; }
        });

        const scBtn = document.querySelector('.sc-btn');
        const scCount = counts['Pan-India'] || 0;
        scBtn.setAttribute('title', `Supreme Court: ${scCount} Case${scCount !== 1 ? 's' : ''}`);
    }

    // --- DATA CLEANING ---
    function clean(text) { return text ? text.replace(/^"|"$/g, '').replace(/""/g, '"').trim() : ""; }
    
    // --- ROBUST CSV PARSER (Handles newlines/quotes inside cells) ---
    function csvToArray(text) {
        let p = '', row = [''], ret = [row], i = 0, r = 0, s = !0, l;
        for (l of text) {
            if ('"' === l) {
                if (s && l === p) row[i] += l;
                s = !s;
            } else if (',' === l && s) l = row[++i] = '';
            else if ('\n' === l && s) {
                if ('\r' === p) row[i] = row[i].slice(0, -1);
                row = ret[++r] = [l = '']; i = 0;
            } else row[i] += l;
            p = l;
        }
        return ret;
    }
</script>

</body>
</html>
