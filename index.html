<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>PEBL | Procedure Established by Law</title>
    <meta name="description" content="Tracking the Reading of Unenumerated Rights into Article 21">
    <meta name="author" content="Abhinav Somani">

    <!-- OPEN GRAPH / SOCIAL SHARING TAGS -->
    <meta property="og:title" content="PEBL | Procedure Established by Law">
    <meta property="og:description" content="Tracking the Reading of Unenumerated Rights into Article 21">
    <meta property="og:image" content="https://pebl-tracker.github.io/social_card.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:url" content="https://pebl-tracker.github.io/">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">

    <!-- DYNAMIC FAVICON -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2250%22 fill=%22%23c0392b%22/><text x=%2250%22 y=%2275%22 font-family=%22Georgia, serif%22 font-weight=%22bold%22 font-size=%2270%22 fill=%22white%22 text-anchor=%22middle%22>P</text></svg>">

    <!-- Google Site Name Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "PEBL",
      "url": "https://pebl-tracker.github.io/"
    }
    </script>

    <!-- LIBRARIES -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <!-- FUSE.JS FOR ADVANCED SEARCH -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

    <style>
        /* --- THEME VARIABLES --- */
        :root { 
            --primary: #2c3e50; --accent: #c0392b; --dissent: #e67e22; --bg: #f8f4e9; 
            --card-bg: #ffffff; --text: #2c2c2c; --text-muted: #5a5a5a;
            --border: #e8e2d8; --tag-bg: #f0ede4; --tag-text: #4a4a4a;
            --input-bg: #ffffff; --parchment: #f2ede4;
            --banner-opacity: 0.95; --banner-filter: sepia(10%) contrast(102%);
            --map-hint-bg: rgba(255, 255, 255, 0.8);
            --timeline-line: #dcd6cc;
            --footer-bg: #e8e2d8;
            
            /* RGB values for map gradient generation */
            --map-base-rgb: 44, 62, 80; 
        }

        [data-theme="dark"] {
            --primary: #ecf0f1; --accent: #e74c3c; --dissent: #d35400; --bg: #121212;
            --card-bg: #1e1e1e; --text: #e0e0e0; --text-muted: #aaaaaa;
            --border: #333333; --tag-bg: #2c3e50; --tag-text: #bdc3c7;
            --input-bg: #252525; --parchment: #1a1a1a;
            --banner-opacity: 0.5; --banner-filter: invert(90%) sepia(10%) hue-rotate(180deg) brightness(0.8);
            --map-hint-bg: rgba(30, 30, 30, 0.9);
            --timeline-line: #333;
            --footer-bg: #1a1a1a;

            /* RGB values for map gradient generation */
            --map-base-rgb: 236, 240, 241;
        }
        
        /* Gradual Transition */
        * { 
            box-sizing: border-box; 
            transition: background-color 0.6s ease, color 0.6s ease, border-color 0.6s ease; 
        }
        
        /* FIX: Forces scrollbar track to always exist, preventing layout jumps */
        html { overflow-y: scroll; }

        body { 
            font-family: "Georgia", serif; 
            background: var(--bg); 
            margin: 0; 
            padding: 0; 
            color: var(--text); 
            line-height: 1.6; 
            overflow-x: hidden; /* FIX: Prevents horizontal scrollbar shift */
            display: flex; 
            flex-direction: column; 
            min-height: 100vh; 
            position: relative; /* FIX: Context for absolute positioning */
        }

        /* Theme Toggle: Decoupled from container to prevent shifting */
        .theme-toggle { 
            position: absolute; 
            top: 20px; 
            right: 20px; 
            background: var(--card-bg); 
            border: 1px solid var(--border); 
            color: var(--text); 
            padding: 6px 12px; 
            cursor: pointer; 
            border-radius: 4px; 
            font-family: sans-serif; 
            font-size: 0.75rem; 
            font-weight: bold; 
            z-index: 1000; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .full-width-banner { width: 100%; height: 180px; overflow: hidden; background-color: var(--parchment); border-bottom: 1px solid var(--border); display: flex; justify-content: center; align-items: center; }
        .banner-img { max-width: 100%; height: 100%; object-fit: contain; opacity: var(--banner-opacity); filter: var(--banner-filter); }

        .container { max-width: 950px; margin: 0 auto; padding: 0 20px 60px 20px; position: relative; flex: 1; }
        
        header { margin-top: 60px; margin-bottom: 40px; text-align: center; }
        h1 { margin: 0; color: var(--primary); font-size: clamp(1.8rem, 5vw, 2.8rem); letter-spacing: -1px; font-weight: bold; }
        header a { text-decoration: none; color: inherit; }
        p.subtitle { color: var(--text-muted); font-size: 1.05rem; margin-top: 12px; font-style: italic; }

        .tab-nav { display: flex; justify-content: center; gap: 25px; margin-bottom: 40px; font-family: sans-serif; border-bottom: 1px solid var(--border); margin-top: 30px; flex-wrap: wrap; }
        .tab-btn { background: none; border: none; font-size: 0.8rem; color: #777; padding: 12px 5px; cursor: pointer; border-bottom: 2px solid transparent; font-weight: bold; letter-spacing: 1.5px; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

        /* --- TRACKER UI --- */
        .map-wrapper { position: relative; width: 100%; max-width: 850px; margin: 0 auto 10px auto; }
        svg { width: 100%; height: auto; filter: drop-shadow(0 4px 10px rgba(0,0,0,0.05)); }
        path { cursor: pointer; fill: var(--tag-bg); stroke: var(--bg); stroke-width: 0.7; }
        path:hover { fill: var(--accent) !important; }

        /* --- MAP TOOLTIP --- */
        .map-tooltip {
            position: fixed;
            background: var(--card-bg);
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 8px 12px;
            border-radius: 4px;
            font-family: sans-serif;
            font-size: 0.8rem;
            font-weight: bold;
            pointer-events: none; /* Allows mouse to pass through to the map */
            display: none;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            white-space: nowrap;
        }

        /* --- HEATMAP LEGEND --- */
        .heatmap-legend {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 0 auto 40px auto;
            font-family: sans-serif;
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        .legend-bar {
            width: 150px;
            height: 10px;
            border-radius: 5px;
            background: linear-gradient(to right, rgba(var(--map-base-rgb), 0.15), rgba(var(--map-base-rgb), 1));
            border: 1px solid var(--border);
        }

        /* UPDATED SC BUTTON: Dynamic Background */
        .sc-btn { 
            display: block; 
            width: fit-content; 
            margin: 0 auto 50px auto; 
            background: var(--card-bg); /* Default, overridden by JS */
            color: var(--text); 
            text-align: center; 
            padding: 10px 25px; 
            border-radius: 50px; 
            text-decoration: none; 
            font-family: sans-serif; 
            font-size: 0.85rem; 
            font-weight: bold; 
            cursor: pointer; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
            border: 2px solid var(--accent); /* Keeps the red identity */
            transition: background-color 0.6s ease, color 0.6s ease;
        }
        .sc-btn:hover { transform: translateY(-2px); }

        .controls-bar { display: flex; gap: 12px; margin-bottom: 25px; background: var(--card-bg); padding: 15px; border: 1px solid var(--border); border-radius: 4px; font-family: sans-serif; flex-wrap: wrap; align-items: center; justify-content: center; }
        #search-input { flex-grow: 2; padding: 10px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text); min-width: 200px; }
        .filter-select { flex-grow: 1; padding: 10px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text); min-width: 150px; }
        
        .download-btn { 
            background: transparent; 
            color: var(--primary); 
            border: 1px solid var(--primary); 
            padding: 10px 20px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-weight: bold; 
            font-size: 0.8rem; 
            white-space: nowrap; 
            transition: all 0.3s ease;
        }
        .download-btn:hover { 
            background: var(--primary); 
            color: var(--bg); 
        }

        #filter-display { text-align: center; margin-bottom: 25px; min-height: 35px; }
        .filter-tag { display: inline-block; background: var(--primary); color: var(--bg); padding: 5px 15px; border-radius: 20px; font-family: sans-serif; font-size: 0.8rem; cursor: pointer; }

        /* --- VERTICAL TIMELINE --- */
        #tab-timeline { width: 100%; display: none; }
        .timeline-container { position: relative; max-width: 1000px; margin: 0 auto; padding: 40px 0; }
        .timeline-container::after { content: ''; position: absolute; width: 4px; background-color: var(--timeline-line); top: 0; bottom: 0; left: 50%; margin-left: -2px; border-radius: 2px; }
        .timeline-item { padding: 10px 40px; position: relative; background-color: inherit; width: 50%; box-sizing: border-box; }
        .timeline-item.left { left: 0; text-align: right; }
        .timeline-item.right { left: 50%; text-align: left; }
        .timeline-dot { position: absolute; width: 20px; height: 20px; right: -10px; background-color: var(--bg); border: 4px solid var(--accent); top: 25px; border-radius: 50%; z-index: 1; transition: transform 0.3s ease; }
        .timeline-item.right .timeline-dot { left: -10px; }
        .timeline-item:hover .timeline-dot { transform: scale(1.3); background-color: var(--accent); }
        .timeline-content { padding: 20px 25px; background-color: var(--card-bg); position: relative; border-radius: 6px; border: 1px solid var(--border); box-shadow: 0 4px 15px rgba(0,0,0,0.03); cursor: pointer; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .timeline-content:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0,0,0,0.08); border-color: var(--accent); }
        .t-date { font-family: sans-serif; font-weight: bold; color: var(--accent); font-size: 0.75rem; margin-bottom: 5px; display: block; letter-spacing: 1px; text-transform: uppercase; }
        .t-title { margin: 0 0 10px 0; font-size: 1.2rem; color: var(--primary); line-height: 1.3; }
        .t-summary { font-size: 0.9rem; color: var(--text-muted); margin: 0; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }

        /* --- CHAIN OF CITATION TAB --- */
        #tab-map { width: 100%; display: none; }
        .map-description { text-align: center; font-style: italic; color: var(--text-muted); margin-bottom: 20px; font-size: 0.95rem; padding: 0 20px; }
        
        /* FIX: Breakout layout to center wide map inside narrow container */
        #tab-map-container { 
            width: 92vw; /* Reduced from 95vw to prevent horizontal scrollbar trigger */
            max-width: 1600px; 
            height: 85vh; 
            margin: 0 auto 40px auto; 
            background: var(--card-bg); 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            position: relative; 
            overflow: hidden; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            
            /* Centering trick for wide elements */
            margin-left: 50%;
            transform: translateX(-50%);
        }
        
        #network-viz { width: 100%; height: 100%; cursor: grab; }
        #network-viz:active { cursor: grabbing; }
        .map-controls { position: absolute; top: 15px; left: 15px; display: flex; flex-direction: column; gap: 8px; z-index: 10; }
        .map-btn { background: var(--bg); border: 1px solid var(--border); padding: 8px 12px; font-size: 0.75rem; cursor: pointer; font-family: sans-serif; border-radius: 4px; font-weight: bold; color: var(--text); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .map-btn:hover { background: var(--tag-bg); }
        .map-hint { position: absolute; bottom: 15px; right: 15px; font-family: sans-serif; font-size: 0.7rem; color: var(--text); pointer-events: none; background: var(--map-hint-bg); padding: 6px 12px; border-radius: 4px; border: 1px solid var(--border); z-index: 10; }

        /* --- JUDGE ANALYTICS TAB (NEW GRID DESIGN) --- */
        #tab-judges { width: 100%; display: none; }
        .judge-stats-container { max-width: 1000px; margin: 0 auto; }
        
        .jurist-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); 
            gap: 25px; 
            padding-bottom: 40px;
        }

        .jurist-card { 
            background: var(--card-bg); 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            padding: 20px; 
            text-align: center; 
            cursor: pointer; 
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .jurist-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 10px 25px rgba(0,0,0,0.08); 
            border-color: var(--accent); 
        }

        .jurist-name { 
            font-family: "Georgia", serif; 
            font-size: 1.1rem; 
            color: var(--primary); 
            margin-bottom: 10px; 
            font-weight: bold;
            line-height: 1.3;
        }

        .jurist-total-label {
            font-family: sans-serif;
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .jurist-total-count {
            font-family: sans-serif;
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 15px;
            line-height: 1;
        }

        .jurist-stats-row {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
            font-family: sans-serif;
            font-size: 0.8rem;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-val { font-weight: bold; }
        .stat-lbl { font-size: 0.65rem; color: var(--text-muted); }

        .jurist-bar-container {
            width: 100%;
            height: 8px;
            background: rgba(0,0,0,0.05);
            border-radius: 4px;
            overflow: hidden;
            display: flex;
        }

        .jb-segment { height: 100%; }
        .jb-auth { background-color: var(--accent); }
        .jb-dissent { background-color: var(--dissent); }
        .jb-bench { background-color: var(--primary); opacity: 0.3; }

        /* --- CARDS --- */
        .case-grid { display: grid; gap: 25px; }
        .card { background: var(--card-bg); padding: 30px; border: 1px solid var(--border); border-left: 5px solid var(--primary); font-family: sans-serif; }
        .card:hover { box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; }
        .card h3 { margin: 0; color: var(--primary); font-size: 1.3rem; line-height: 1.3; flex: 1; }
        .court-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; font-weight: bold; margin-left: 15px; }
        .card-date { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 10px; font-weight: bold; }
        .citation { font-family: "Georgia", serif; color: var(--text-muted); font-style: italic; display: block; margin-bottom: 10px; font-size: 0.95rem; }
        
        /* UPDATED BENCH INFO STYLE */
        .bench-info { font-size: 0.85rem; color: var(--text); margin-bottom: 15px; font-family: sans-serif; }
        
        /* NATURE BADGES (Explicit/Implicit) */
        .nature-badge {
            font-size: 0.65rem;
            text-transform: uppercase;
            padding: 3px 8px;
            border-radius: 4px;
            margin-left: 10px;
            font-weight: bold;
            letter-spacing: 0.5px;
            vertical-align: middle;
            display: inline-block;
        }
        .nature-explicit {
            background-color: var(--primary);
            color: var(--bg);
            border: 1px solid var(--primary);
        }
        .nature-implicit {
            background-color: transparent;
            color: var(--text-muted);
            border: 1px solid var(--text-muted);
        }

        /* CONTEST BADGES */
        .contest-badge {
            font-size: 0.65rem;
            text-transform: uppercase;
            padding: 3px 8px;
            border-radius: 4px;
            margin-left: 5px;
            font-weight: bold;
            letter-spacing: 0.5px;
            vertical-align: middle;
            display: inline-block;
        }
        .contest-contested {
            background-color: var(--dissent); /* Orange/Red for contested */
            color: var(--bg);
            border: 1px solid var(--dissent);
        }
        .contest-uncontested {
            background-color: transparent;
            color: var(--text-muted);
            border: 1px solid var(--text-muted);
        }

        .tag { background: var(--tag-bg); padding: 4px 10px; border-radius: 3px; font-size: 0.7rem; font-weight: bold; color: #666; display: inline-block; margin-right: 6px; margin-bottom: 6px; text-transform: uppercase; }
        .summary-preview { color: var(--text); line-height: 1.6; margin-bottom: 15px; font-size: 0.95rem; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        .action-link { color: var(--primary); font-weight: bold; text-decoration: none; border-bottom: 2px solid var(--primary); cursor: pointer; font-size: 0.85rem; }

        /* --- DETAILS VIEW --- */
        #details-view { display: none; background: var(--bg); padding: 20px 0; }
        .back-btn { display: inline-block; margin-bottom: 30px; cursor: pointer; color: var(--text-muted); font-family: sans-serif; font-size: 0.8rem; font-weight: bold; letter-spacing: 1px; }
        .details-meta { border-bottom: 1px solid var(--border); padding-bottom: 20px; margin-bottom: 30px; }
        .details-body { font-size: 1.15rem; line-height: 1.8; white-space: pre-wrap; color: var(--text); text-align: justify; }
        .external-btn { 
            display: inline-block; 
            background: var(--primary); 
            color: var(--bg); 
            padding: 12px 25px; 
            text-decoration: none; 
            border-radius: 4px; 
            font-family: sans-serif; 
            font-weight: bold; 
            margin-bottom: 10px; 
        }
        .copy-btn { background: none; border: 1px solid var(--border); color: var(--text-muted); cursor: pointer; font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; margin-left: 10px; vertical-align: middle; }
        .copy-btn:hover { background: var(--tag-bg); color: var(--primary); }
        
        .detail-footer-note {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
            font-style: italic;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        /* --- ABOUT TAB JUSTIFICATION --- */
        #tab-about p { text-align: justify; }
        
        /* --- ABOUT TAB STYLING --- */
        #about-content h2 { color: var(--primary); border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-top: 40px; }
        #about-content p { margin-bottom: 20px; line-height: 1.8; }
        #about-content a { color: var(--accent); text-decoration: none; font-weight: bold; }

        /* --- FOOTER --- */
        footer { background-color: var(--footer-bg); padding: 40px 20px; margin-top: 60px; border-top: 1px solid var(--border); text-align: center; font-size: 0.85rem; color: var(--text-muted); }
        .footer-content { max-width: 800px; margin: 0 auto; }
        .cite-btn { background: var(--card-bg); border: 1px solid var(--border); padding: 8px 15px; border-radius: 20px; cursor: pointer; font-family: sans-serif; font-weight: bold; color: var(--primary); margin-top: 15px; display: inline-block; }
        .cite-btn:hover { background: var(--primary); color: var(--bg); }

        /* --- LOADING & SCROLL --- */
        #loading { text-align: center; color: var(--text-muted); padding: 60px; font-style: italic; }
        .loader { border: 4px solid var(--border); border-top: 4px solid var(--accent); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 15px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .scroll-top-btn { position: fixed; bottom: 30px; right: 30px; background: var(--primary); color: var(--bg); border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 100; }
        .scroll-top-btn:hover { transform: translateY(-3px); }

        /* --- MOBILE RESPONSIVENESS --- */
        @media (max-width: 600px) {
            .full-width-banner { height: auto; padding: 0; border-bottom: 1px solid var(--border); }
            .banner-img { width: 100%; height: auto; object-fit: contain; display: block; }
            header { margin-top: 0; padding-top: 50px; } 
            .card-header { flex-direction: column; }
            .court-label { margin-left: 0; margin-top: 5px; }
            .theme-toggle { top: 10px; right: 10px; }
            #tab-map-container { width: 100vw; height: 70vh; border-radius: 0; border-left: none; border-right: none; margin-left: 0; transform: none; }
            .map-wrapper { max-width: 100%; }
            .timeline-container::after { left: 31px; }
            .timeline-item { width: 100%; padding-left: 70px; padding-right: 25px; }
            .timeline-item.left, .timeline-item.right { left: 0; text-align: left; }
            .timeline-dot { left: 21px !important; right: auto; }
            .controls-bar { flex-direction: column; gap: 10px; align-items: stretch; }
            #search-input, .filter-select, .download-btn { width: 100%; flex-grow: 1; }
            
            /* Judge Analytics Mobile */
            .judge-name-col { width: 100%; text-align: left; margin-bottom: 5px; }
            .judge-stat-row { flex-direction: column; align-items: stretch; }
            .judge-bar-col { width: 100%; }
            .judge-count-col { width: 100%; text-align: right; margin-top: 5px; }
        }
    </style>
</head>
<body>

<!-- THEME TOGGLE (Decoupled from container) -->
<button class="theme-toggle" onclick="toggleTheme()">üåì Theme</button>

<!-- BANNER AREA -->
<div class="full-width-banner">
    <img src="article21.png" alt="Article 21 Calligraphy" class="banner-img" onerror="this.parentElement.style.display='none'">
</div>

<!-- TOOLTIP CONTAINER -->
<div id="map-tooltip" class="map-tooltip"></div>

<div class="container">
    <header>
        <div class="header-content">
            <a href="."><h1>Procedure Established by Law</h1></a>
            <p class="subtitle">Tracking the Reading of Unenumerated Rights into Article 21</p>
        </div>
    </header>

    <nav class="tab-nav">
        <button id="btn-tracker" class="tab-btn active" onclick="switchTab('tracker')">TRACKER</button>
        <button id="btn-timeline" class="tab-btn" onclick="switchTab('timeline')">TIMELINE</button>
        <button id="btn-map" class="tab-btn" onclick="switchTab('map')">CHAIN OF CITATION</button>
        <button id="btn-judges" class="tab-btn" onclick="switchTab('judges')">JURIST HEATMAP</button>
        <button id="btn-about" class="tab-btn" onclick="switchTab('about')">ABOUT</button>
    </nav>

    <!-- TAB: TRACKER -->
    <div id="tab-tracker" class="tab-content">
        <div class="map-wrapper" id="map-container"></div>
        
        <!-- HEATMAP LEGEND -->
        <div class="heatmap-legend">
            <span>Low Activity</span>
            <div class="legend-bar"></div>
            <span>High Activity</span>
        </div>

        <div class="sc-btn" onclick="handleMapClick('Pan-India')">‚òÖ Supreme Court (Pan-India)</div>
        
        <div class="controls-bar">
            <input type="text" id="search-input" placeholder="Search cases or keywords..." onkeyup="handleSearch()">
            <select id="right-filter" class="filter-select" onchange="handleSearch()"><option value="">All Rights</option></select>
            <select id="nature-filter" class="filter-select" onchange="handleSearch()">
                <option value="">All Declarations</option>
                <option value="explicit">Explicit</option>
                <option value="implicit">Implicit</option>
            </select>
            <select id="contest-filter" class="filter-select" onchange="handleSearch()">
                <option value="">All Contest Status</option>
                <option value="contested">Contested</option>
                <option value="uncontested">Uncontested</option>
            </select>
            <select id="state-filter" class="filter-select" onchange="handleSearch()"><option value="">All Jurisdictions</option></select>
            <select id="court-filter" class="filter-select" onchange="handleSearch()"><option value="">All Courts</option></select>
            <select id="judge-filter" class="filter-select" onchange="handleSearch()"><option value="">All Judges</option></select>
            <select id="sort-order" class="filter-select" onchange="handleSearch()"><option value="newest">Newest First</option><option value="oldest">Oldest First</option></select>
            <button class="download-btn" onclick="downloadData()">Download Filtered Data (CSV)</button>
            <div id="case-count-display" style="font-family:sans-serif; font-size:0.8rem; color:var(--text-muted); font-weight:bold; white-space:nowrap; align-self:center;"></div>
        </div>
        <div id="filter-display"></div>
        <div id="loading">
            <div class="loader"></div>
            Consulting the Archives...
        </div>
        <div class="case-grid" id="case-list"></div>
    </div>

    <!-- TAB: TIMELINE (VERTICAL) -->
    <div id="tab-timeline" class="tab-content">
        <p class="map-description">
            A chronological history of the expansion of Article 21.<br>
            <span style="font-size: 0.8rem;">Format inspired by <a href="https://www.scobserver.in/journal/the-right-to-life-and-personal-liberty-under-article-21-a-timeline/" target="_blank" style="color: var(--accent); text-decoration: none;">Supreme Court Observer</a>.</span>
        </p>
        <div class="timeline-container" id="timeline-container">
            <!-- Items injected via JS -->
        </div>
    </div>

    <!-- TAB: CHAIN OF CITATION -->
    <div id="tab-map" class="tab-content">
        <p class="map-description">
            Visualizing the citation network between key Article 21 judgments.<br>
            <span style="font-size: 0.8rem;">Nodes represent cases. Arrows indicate citations.</span>
        </p>
        <div id="tab-map-container">
            <div id="network-viz"></div>
            <div class="map-controls">
                <button class="map-btn" onclick="zoomMap(1.2)">+</button>
                <button class="map-btn" onclick="zoomMap(0.8)">-</button>
                <button class="map-btn" onclick="resetMap()">Fit</button>
                <button class="map-btn" id="physics-btn" onclick="togglePhysics()">Freeze</button>
                <button class="map-btn" onclick="initCitationMap()">Reload Map</button>
            </div>
            <div class="map-hint">Scroll to Zoom ‚Ä¢ Drag to Pan</div>
        </div>
    </div>

    <!-- TAB: JUDGE ANALYTICS -->
    <div id="tab-judges" class="tab-content">
        <p class="map-description">
            Frequency of participation in Article 21 cases.<br>
            <span style="font-size: 0.8rem; color: var(--text-muted);">
                <span style="display:inline-block; width:10px; height:10px; background:var(--accent); margin-right:5px;"></span>Authored
                <span style="display:inline-block; width:10px; height:10px; background:var(--dissent); margin-left:15px; margin-right:5px;"></span>Dissenting
                <span style="display:inline-block; width:10px; height:10px; background:var(--primary); opacity:0.3; margin-left:15px; margin-right:5px;"></span>Concurring/Bench
            </span>
        </p>
        <div class="judge-stats-container" id="judge-stats-list">
            <!-- Injected via JS -->
        </div>
    </div>

    <!-- TAB: ABOUT -->
    <div id="tab-about" class="tab-content" style="display: none;">
        <div style="max-width: 700px; margin: 0 auto;">
            <div id="about-loading" style="text-align:center; padding:40px;">
                <div class="loader"></div>
                Loading About Content...
            </div>
            <div id="about-content"></div>
        </div>
    </div>

    <!-- DETAILS VIEW (CASES) -->
    <div id="details-view">
        <div class="back-btn" onclick="closeDetails()">‚Üê BACK TO TRACKER</div>
        <div class="details-meta">
            <h2 id="detail-title" style="margin-top:0; color: var(--primary); font-size: 2.2rem;">Case Name</h2>
            <div id="detail-citation" class="citation" style="font-size: 1.2rem;">
                <span id="raw-citation">Citation</span> 
                <button class="copy-btn" onclick="copyCaseCitation()">Copy</button>
            </div>
            <div style="margin-top: 20px;">
                <span class="tag" id="detail-court">Court</span>
                <span id="detail-nature-container"></span>
                <span id="detail-contest-container"></span>
                <span id="detail-rights-container"></span>
                <span class="tag" id="detail-date" style="background:var(--tag-bg);">Date</span>
            </div>
        </div>
        <div class="details-body" id="detail-summary"></div>
        <div id="detail-links-container" style="margin-top: 40px; display: flex; gap: 15px; flex-wrap: wrap;"></div>
        <div class="detail-footer-note">
            Have a concern pertaining to this case? Reach out at <a href="mailto:pebl.tracker@gmail.com" style="color:var(--accent); text-decoration:none;">pebl.tracker@gmail.com</a>.
        </div>
    </div>
</div>

<!-- FOOTER -->
<footer>
    <div class="footer-content">
        <p><strong>Disclaimer:</strong> The content on this tracker is for academic and informational purposes only. It does not constitute legal advice. Summaries are the curator's interpretation and should not be cited as legal authority. Please refer to the official judgment text.</p>
        <button class="cite-btn" onclick="copyArchiveCitation()">Cite This Tracker</button>
    </div>
</footer>

<!-- BACK TO TOP BUTTON -->
<button class="scroll-top-btn" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">‚Üë</button>

<script>
    // --- THEME LOGIC ---
    function toggleTheme() {
        const current = document.documentElement.getAttribute('data-theme');
        const target = current === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', target);
        localStorage.setItem('theme', target);
        generateHeatmap(); 
        if(network) initCitationMap(); 
    }

    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);

    // --- DATA LOGIC ---
    const SHEET_ID = '1k3O3nEbs24UXsoAsrNPmaZfBvpAJCmaEzypuQTD-yuY';
    // UPDATED: Using export?format=csv to avoid gviz type inference issues
    const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0`;
    
    // *** REPLACE THIS WITH YOUR NEW SHEET GID ***
    const ABOUT_SHEET_GID = '1656982748'; 
    const ABOUT_CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${ABOUT_SHEET_GID}`;

    // --- SMART SEARCH SYNONYMS ---
    const synonymMap = {
        "road": ["street", "highway", "traffic", "pothole", "infrastructure"],
        "street": ["road", "highway"],
        "health": ["medical", "treatment", "hospital", "doctor", "healthcare"],
        "environment": ["pollution", "climate", "ecology", "clean air", "water", "forest"],
        "housing": ["shelter", "residence", "home", "eviction", "slum"],
        "privacy": ["surveillance", "data", "aadhaar", "personal liberty"],
        "jail": ["prison", "custody", "incarceration", "bail", "undertrial"],
        "education": ["school", "college", "university", "student"],
        "internet": ["digital", "web", "online", "connectivity"],
        "women": ["gender", "female", "maternity", "sexual harassment"],
        "child": ["juvenile", "minor", "infant"],
        "marriage": ["married", "matrimony", "wedlock", "spouse", "husband", "wife", "marry"],
        "married": ["marriage", "matrimony", "wedlock", "spouse", "husband", "wife", "marry"],
        "marry": ["marriage", "married", "matrimony", "wedlock", "spouse"]
    };

    let allCases = [];
    let filteredCases = []; 
    let network = null;
    let physicsEnabled = true;

    window.addEventListener('DOMContentLoaded', () => {
        loadMap();
        fetchData();
        fetchAboutData(); // Fetch dynamic about content
        
        // Scroll Listener for Back-to-Top
        window.addEventListener('scroll', () => {
            const btn = document.querySelector('.scroll-top-btn');
            if (window.scrollY > 300) btn.style.display = 'block';
            else btn.style.display = 'none';
        });

        // Attach tooltip listener to the static SC button
        const scBtn = document.querySelector('.sc-btn');
        if(scBtn) attachTooltip(scBtn, 'Supreme Court (Pan-India)');
    });

    // Helper to attach tooltip logic to any element
    function attachTooltip(element, name) {
        const tooltip = document.getElementById('map-tooltip');
        element.addEventListener('mouseenter', () => {
            const count = element.getAttribute('data-count') || 0;
            const label = count == 1 ? 'Case' : 'Cases';
            tooltip.innerHTML = `${name}<br><span style="font-weight:normal; opacity:0.8;">${count} ${label}</span>`;
            tooltip.style.display = 'block';
        });

        element.addEventListener('mousemove', (e) => {
            tooltip.style.left = (e.clientX + 15) + 'px';
            tooltip.style.top = (e.clientY + 15) + 'px';
        });

        element.addEventListener('mouseleave', () => {
            tooltip.style.display = 'none';
        });
    }

    function loadMap() {
        fetch('india.svg').then(r => r.text()).then(svg => {
            document.getElementById('map-container').innerHTML = svg;
            
            document.querySelectorAll('#map-container path').forEach(p => {
                let name = p.getAttribute('name');
                if(name) {
                    // FIX: Remove diacritics specifically for Dadra...
                    if(name === "DƒÅdra and Nagar Haveli and DamƒÅn and Diu") {
                        name = "Dadra and Nagar Haveli and Daman and Diu";
                        p.setAttribute('name', name); // Update DOM so CSS selectors/logic work if needed
                    }
                    // FIX: Rename Uttaranchal to Uttarakhand
                    if(name === "Uttaranchal") {
                        name = "Uttarakhand";
                        p.setAttribute('name', name);
                    }

                    p.setAttribute('role', 'button');
                    p.setAttribute('aria-label', `View cases for ${name}`);
                    attachTooltip(p, name);
                }
                p.addEventListener('click', () => {
                    if(name) handleMapClick(name);
                });
            });
            generateHeatmap();
        }).catch(err => console.error("Map load failed", err));
    }

    // --- SLUG HELPER ---
    function createSlug(text) {
        return text.toString().toLowerCase()
            .replace(/\s+/g, '-')           // Replace spaces with -
            .replace(/[^\w\-]+/g, '')       // Remove all non-word chars
            .replace(/\-\-+/g, '-')         // Replace multiple - with single -
            .replace(/^-+/, '')             // Trim - from start
            .replace(/-+$/, '');            // Trim - from end
    }

    function smartSplit(str) {
        if (!str) return [];
        if (str.includes(';')) {
            return str.split(';').map(s => s.trim()).filter(s => s);
        }
        return str.split(',').map(s => s.trim()).filter(s => s);
    }

    function fetchData() {
        fetch(CSV_URL).then(r => {
            if (!r.ok) throw new Error("Network response was not ok");
            return r.text();
        }).then(csv => {
            const parsed = Papa.parse(csv, { header: false, skipEmptyLines: true });
            allCases = parsed.data.slice(1).map(row => {
                let state = (row[3] || "Pan-India").trim();
                if(state === "Uttaranchal") state = "Uttarakhand";

                return {
                    name: (row[0] || "").trim(),
                    slug: createSlug((row[0] || "").trim()), // Generate Slug
                    citation: (row[1] || "").trim(),
                    court: (row[2] || "").trim(),
                    state: state,
                    rights: smartSplit(row[4]),
                    summary: (row[5] || "").trim(),
                    links: smartSplit(row[6]),
                    date: (row[7] || "").trim(),
                    cites: smartSplit(row[8]).filter(c => c.toLowerCase() !== 'none' && c !== '-'),
                    judges: smartSplit(row[9]),
                    nature: (row[10] || "").trim(),
                    contest: (row[11] || "").trim() // Column L
                };
            }).filter(c => c.name && c.name !== "Case Name");

            filteredCases = allCases; 
            document.getElementById('loading').style.display = 'none';
            populateDropdown();
            populateStateDropdown(); 
            populateCourtDropdown(); 
            populateJudgeDropdown(); 
            generateHeatmap();
            handleSearch();
            checkUrlParams(); 
        }).catch(error => {
            document.getElementById('loading').innerHTML = `<p style="color:var(--accent); font-weight:bold;">Unable to load case data.<br>Please check your internet connection or try again later.</p>`;
            console.error("Data fetch failed:", error);
        });
    }

    // --- FETCH DYNAMIC ABOUT CONTENT ---
    function fetchAboutData() {
        // If user hasn't set GID yet, show default or error
        if(ABOUT_SHEET_GID === 'YOUR_NEW_GID_HERE') {
            document.getElementById('about-loading').innerHTML = "Please configure the ABOUT_SHEET_GID in the code.";
            return;
        }

        fetch(ABOUT_CSV_URL).then(r => {
            if (!r.ok) throw new Error("About sheet fetch failed");
            return r.text();
        }).then(csv => {
            const parsed = Papa.parse(csv, { header: false, skipEmptyLines: true });
            const rows = parsed.data.slice(1); // Skip header
            
            const container = document.getElementById('about-content');
            container.innerHTML = ''; // Clear loading

            rows.forEach(row => {
                const title = (row[0] || "").trim();
                const content = (row[1] || "").trim();

                if(title && content) {
                    const section = document.createElement('div');
                    section.innerHTML = `<h2>${title}</h2><p>${content}</p>`;
                    container.appendChild(section);
                }
            });
            
            document.getElementById('about-loading').style.display = 'none';
        }).catch(err => {
            console.error(err);
            document.getElementById('about-loading').innerHTML = "Failed to load content.";
        });
    }

    // --- CITATION & EXPORT LOGIC ---
    function copyCaseCitation() {
        const text = document.getElementById('raw-citation').innerText.trim();
        navigator.clipboard.writeText(text).then(() => alert('Citation copied to clipboard!'));
    }

    function copyArchiveCitation() {
        const d = new Date();
        const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const dateStr = `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
        const citation = `Abhinav Somani, 'Procedure Established by Law' (PEBL, 2026) <https://pebl-tracker.github.io> accessed ${dateStr}.`;
        navigator.clipboard.writeText(citation).then(() => alert('Tracker citation copied to clipboard!'));
    }

    function downloadData() {
        const csv = Papa.unparse(filteredCases);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", "pebl_data.csv");
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // --- VERTICAL TIMELINE LOGIC ---
    function initTimeline() {
        const container = document.getElementById('timeline-container');
        container.innerHTML = '';
        
        const validCases = allCases.filter(c => {
            const d = parseDate(c.date);
            return d.getTime() > 0;
        }).sort((a, b) => parseDate(a.date) - parseDate(b.date));

        if(validCases.length === 0) return;

        validCases.forEach((c, index) => {
            const d = parseDate(c.date);
            const dateStr = d.toLocaleDateString('en-GB', {day:'numeric', month:'short', year:'numeric'});
            const side = index % 2 === 0 ? 'left' : 'right';
            
            const item = document.createElement('div');
            item.className = `timeline-item ${side}`;
            
            item.innerHTML = `
                <div class="timeline-dot"></div>
                <div class="timeline-content" onclick="openDetails('${c.slug}')">
                    <span class="t-date">${dateStr} ‚Ä¢ ${c.court.toUpperCase()}</span>
                    <h3 class="t-title">${c.name}</h3>
                    <p class="t-summary">${c.summary}</p>
                </div>
            `;
            container.appendChild(item);
        });
    }

    // --- JUDGE ANALYTICS LOGIC ---
    function initJudgeAnalytics() {
        const container = document.getElementById('judge-stats-list');
        container.innerHTML = '';

        const stats = {};
        
        allCases.forEach(c => {
            c.judges.forEach(rawName => {
                const cleanName = cleanJudgeName(rawName);
                if(!stats[cleanName]) stats[cleanName] = { total: 0, authored: 0, dissenting: 0 };
                
                stats[cleanName].total++;
                if(rawName.toLowerCase().includes('(author)') || rawName.toLowerCase().includes('(auth.)') || rawName.includes('*')) {
                    stats[cleanName].authored++;
                }
                if(rawName.toLowerCase().includes('(dissent)')) {
                    stats[cleanName].dissenting++;
                }
            });
        });

        const sortedJudges = Object.keys(stats)
            .map(name => ({ name, ...stats[name] }))
            .sort((a, b) => {
                // 1. Sort by Total Cases (High to Low)
                if (b.total !== a.total) return b.total - a.total;
                // 2. If Total is same, sort by Authored (High to Low)
                if (b.authored !== a.authored) return b.authored - a.authored;
                // 3. If both are same, sort Alphabetically (A to Z)
                return a.name.localeCompare(b.name);
            });

        if(sortedJudges.length === 0) {
            container.innerHTML = '<p style="text-align:center; color:var(--text-muted);">No judge data available.</p>';
            return;
        }

        // Create Grid Wrapper
        container.innerHTML = '<div class="jurist-grid"></div>';
        const grid = container.querySelector('.jurist-grid');

        sortedJudges.forEach(j => {
            // Calculate percentages relative to THIS judge's total (Composition Scaling)
            const authPct = (j.authored / j.total) * 100; 
            const dissentPct = (j.dissenting / j.total) * 100;
            const benchPct = ((j.total - j.authored - j.dissenting) / j.total) * 100;

            const card = document.createElement('div');
            card.className = 'jurist-card';
            card.onclick = () => {
                switchTab('tracker');
                document.getElementById('judge-filter').value = j.name;
                handleSearch();
                document.getElementById('search-input').scrollIntoView({behavior: "smooth", block: "start"});
            };

            card.innerHTML = `
                <div class="jurist-name">${j.name}</div>
                <div class="jurist-total-label">Total Cases</div>
                <div class="jurist-total-count">${j.total}</div>
                
                <div class="jurist-stats-row">
                    <div class="stat-item">
                        <span class="stat-val" style="color:var(--accent)">${j.authored}</span>
                        <span class="stat-lbl">Authored</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-val" style="color:var(--dissent)">${j.dissenting}</span>
                        <span class="stat-lbl">Dissent</span>
                    </div>
                </div>

                <div class="jurist-bar-container">
                    <div class="jb-segment jb-auth" style="width: ${authPct}%"></div>
                    <div class="jb-segment jb-dissent" style="width: ${dissentPct}%"></div>
                    <div class="jb-segment jb-bench" style="width: ${benchPct}%"></div>
                </div>
            `;
            grid.appendChild(card);
        });
    }

    // --- CHAIN OF CITATION LOGIC ---
    function initCitationMap() {
        // Safety Check: Ensure Vis.js is loaded
        if (typeof vis === 'undefined') {
            console.error("Vis.js library not loaded.");
            document.getElementById('network-viz').innerHTML = '<p style="text-align:center; padding-top:50px; color:var(--text-muted);">Visualization library failed to load. Please refresh.</p>';
            return;
        }

        // Safety Check: Ensure data exists
        if (allCases.length === 0) return;

        const container = document.getElementById('network-viz');
        
        // Cleanup existing network to prevent memory leaks or double rendering
        if (network !== null) {
            network.destroy();
            network = null;
        }

        const nodes = [];
        const edges = [];
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';

        allCases.forEach((c) => {
            const year = parseDate(c.date).getFullYear();
            nodes.push({
                id: c.name,
                label: c.name.split(' v. ')[0],
                title: `${c.name}\nCourt: ${c.court}\nYear: ${year}`,
                value: 15,
                color: {
                    background: isDark ? '#2c3e50' : '#ffffff',
                    border: isDark ? '#ecf0f1' : '#2c3e50',
                    highlight: { background: '#c0392b', border: '#c0392b' }
                },
                font: { color: isDark ? '#e0e0e0' : '#2c2c2c', size: 14, face: 'Georgia' }
            });

            c.cites.forEach(citedCaseName => {
                if (allCases.some(x => x.name === citedCaseName)) {
                    edges.push({
                        from: c.name,
                        to: citedCaseName,
                        arrows: { to: { enabled: true, scaleFactor: 0.5 } },
                        color: { color: isDark ? '#555' : '#bbb', opacity: 0.8 },
                        width: 2,
                        smooth: { type: 'curvedCW', roundness: 0.2 }
                    });
                }
            });
        });

        const data = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };
        const options = {
            nodes: { shape: 'dot', scaling: { min: 10, max: 30 } },
            physics: {
                enabled: physicsEnabled,
                forceAtlas2Based: { gravitationalConstant: -250, centralGravity: 0.01, springLength: 300, springConstant: 0.05 },
                solver: 'forceAtlas2Based',
                stabilization: { iterations: 150 }
            },
            interaction: { dragNodes: true, dragView: true, zoomView: true, hover: true, tooltipDelay: 200 }
        };

        try {
            network = new vis.Network(container, data, options);
            network.on("click", (params) => {
                if (params.nodes.length > 0) openDetails(encodeURIComponent(params.nodes[0]));
            });
        } catch (e) {
            console.error("Vis.js initialization error:", e);
        }
    }

    function zoomMap(scale) { if(network) network.moveTo({ scale: network.getScale() * scale }); }
    function resetMap() { if(network) network.fit({ animation: true }); }
    function togglePhysics() {
        if(!network) return;
        physicsEnabled = !physicsEnabled;
        network.setOptions({ physics: { enabled: physicsEnabled } });
        document.getElementById('physics-btn').innerText = physicsEnabled ? "Freeze" : "Unfreeze";
    }

    // --- UI LOGIC ---
    function switchTab(t, pushState = true) {
        document.querySelectorAll('.tab-content, #details-view').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + t).style.display = 'block';
        document.getElementById('btn-' + t).classList.add('active');
        
        if(t === 'map') setTimeout(initCitationMap, 100);
        if(t === 'timeline') setTimeout(initTimeline, 100);
        if(t === 'judges') setTimeout(initJudgeAnalytics, 100);

        if(pushState) {
            const url = new URL(window.location);
            url.searchParams.set('tab', t);
            url.searchParams.delete('case'); 
            window.history.pushState({}, '', url);
        }
    }

    function cleanJudgeName(name) {
        return name.replace(/\(Author\)/gi, '').replace(/\(Auth\.\)/gi, '').replace(/\(Dissent\)/gi, '').replace(/\*/g, '').trim();
    }

    function handleSearch() {
        const rawQuery = document.getElementById('search-input').value.toLowerCase().trim();
        const right = document.getElementById('right-filter').value;
        const nature = document.getElementById('nature-filter').value;
        const contest = document.getElementById('contest-filter').value;
        const state = document.getElementById('state-filter').value; 
        const court = document.getElementById('court-filter').value; 
        const judge = document.getElementById('judge-filter').value; 
        const sort = document.getElementById('sort-order').value;

        // --- MULTI-PASS FUZZY SEARCH ---
        let textResults = allCases;
        if (rawQuery) {
            // 1. Generate Search Terms (Original + Synonyms)
            let searchTerms = [rawQuery];
            Object.keys(synonymMap).forEach(key => {
                if (rawQuery.includes(key)) {
                    searchTerms = [...searchTerms, ...synonymMap[key]];
                }
            });
            // Deduplicate terms
            searchTerms = [...new Set(searchTerms)];

            // 2. Configure Fuse
            const fuseOptions = {
                includeScore: true,
                threshold: 0.2, // TIGHTER THRESHOLD (was 0.4)
                minMatchCharLength: 3, // IGNORE SHORT MATCHES
                ignoreLocation: true, 
                keys: [
                    { name: 'name', weight: 0.4 },
                    { name: 'rights', weight: 0.3 },
                    { name: 'summary', weight: 0.2 },
                    { name: 'judges', weight: 0.1 },
                    { name: 'court', weight: 0.1 }
                ]
            };
            const fuse = new Fuse(allCases, fuseOptions);

            // 3. Run Search for EACH term independently
            let combinedResults = [];
            const seenIndices = new Set();

            searchTerms.forEach(term => {
                const results = fuse.search(term);
                results.forEach(r => {
                    if (!seenIndices.has(r.refIndex)) {
                        seenIndices.add(r.refIndex);
                        combinedResults.push(r);
                    }
                });
            });

            // 4. Sort by Score (lower is better in Fuse)
            combinedResults.sort((a, b) => a.score - b.score);
            textResults = combinedResults.map(r => r.item);
        }

        // --- FILTERING ---
        let filtered = textResults.filter(c => {
            const matchesRight = right ? c.rights.includes(right) : true;
            const matchesNature = nature ? c.nature.toLowerCase() === nature : true;
            const matchesContest = contest ? c.contest.toLowerCase() === contest : true;
            const matchesState = state ? c.state === state : true; 
            const matchesCourt = court ? c.court === court : true; 
            const matchesJudge = judge ? c.judges.some(j => cleanJudgeName(j) === judge) : true;
            return matchesRight && matchesNature && matchesContest && matchesState && matchesCourt && matchesJudge;
        });
        
        // --- SORTING ---
        if (!rawQuery || sort !== 'newest') { 
             if(sort === 'newest') {
                 filtered.sort((a, b) => parseDate(b.date) - parseDate(a.date));
             } else {
                 filtered.sort((a, b) => parseDate(a.date) - parseDate(b.date));
             }
        }

        filteredCases = filtered; 
        renderCases(filtered);
    }

    function renderCases(cases) {
        const list = document.getElementById('case-list');
        const countDisplay = document.getElementById('case-count-display');
        
        if(allCases.length === cases.length) {
            countDisplay.innerText = `Total Cases: ${allCases.length}`;
        } else {
            countDisplay.innerText = `Showing ${cases.length} of ${allCases.length}`;
        }

        list.innerHTML = cases.length ? '' : '<p style="text-align:center; color:var(--text-muted); padding: 40px;">No judgments found.</p>';
        cases.forEach(c => {
            const tags = c.rights.map(r => `<span class="tag">${r}</span>`).join('');
            
            let benchHTML = '';
            if (c.judges.length > 0) {
                const formattedJudges = c.judges.map(j => {
                    let display = cleanJudgeName(j);
                    if (j.toLowerCase().includes('(author)') || j.toLowerCase().includes('(auth.)') || j.includes('*')) {
                        display += ' (Auth.)';
                    }
                    if (j.toLowerCase().includes('(dissent)')) {
                        display = `<span style="color:var(--dissent)">${display} (Dissent)</span>`;
                    }
                    return display;
                }).join(', ');
                benchHTML = `<div class="bench-info"><span style="color:var(--text-muted); font-weight:bold;">Justice(s):</span> ${formattedJudges}</div>`;
            }
            
            let natureBadge = '';
            if(c.nature) {
                const typeClass = c.nature.toLowerCase() === 'implicit' ? 'nature-implicit' : 'nature-explicit';
                natureBadge = `<span class="nature-badge ${typeClass}">${c.nature}</span>`;
            }

            let contestBadge = '';
            if(c.contest) {
                const isContested = c.contest.toLowerCase() === 'contested';
                const contestClass = isContested ? 'contest-contested' : 'contest-uncontested';
                contestBadge = `<span class="contest-badge ${contestClass}">${c.contest}</span>`;
            }
            
            let dDisp = c.date;
            try { 
                const d = parseDate(c.date); 
                if(d.getTime() > 0) dDisp = d.toLocaleDateString('en-GB', {day:'numeric', month:'short', year:'numeric'});
            } catch(e){}

            list.innerHTML += `
                <div class="card">
                    <div class="card-header"><h3>${c.name}</h3><span class="court-label">${c.court} ${natureBadge} ${contestBadge}</span></div>
                    <div class="card-date">${dDisp}</div>
                    <span class="citation">${c.citation}</span>
                    ${benchHTML}
                    <div>${tags}</div>
                    <div class="summary-preview">${c.summary}</div>
                    <a class="action-link" onclick="openDetails('${c.slug}')">READ MORE ‚Üí</a>
                </div>`;
        });
    }

    function parseDate(s) {
        if(!s) return new Date(0);
        const p = s.split(/[-/.]/);
        return p.length === 3 ? new Date(p[2], p[1]-1, p[0]) : (p.length === 1 ? new Date(p[0],0,1) : new Date(s));
    }

    function handleMapClick(n) {
        switchTab('tracker');
        const dropdown = document.getElementById('state-filter');
        let optionExists = Array.from(dropdown.options).some(o => o.value === n);
        if (!optionExists) {
            const opt = document.createElement('option');
            opt.value = n;
            opt.innerText = n;
            dropdown.appendChild(opt);
        }
        dropdown.value = n;
        handleSearch();
        document.getElementById('search-input').scrollIntoView({behavior: "smooth", block: "start"});
    }

    function openDetails(identifier) {
        // identifier could be "Maneka Gandhi..." (Old) or "maneka-gandhi..." (New)
        // We decode it just in case it's an old link with %20
        const decoded = decodeURIComponent(identifier);
        const c = allCases.find(x => x.slug === identifier || x.name === decoded);
        
        if(!c) return;
        
        window.history.pushState({}, '', '?case=' + c.slug);
        document.getElementById('detail-title').innerText = c.name;
        document.getElementById('detail-citation').innerHTML = `<span id="raw-citation">${c.citation}</span> <button class="copy-btn" onclick="copyCaseCitation()">Copy</button>`;
        document.getElementById('detail-court').innerText = c.court;
        document.getElementById('detail-date').innerText = c.date;
        document.getElementById('detail-summary').innerText = c.summary;
        document.getElementById('detail-rights-container').innerHTML = c.rights.map(r => `<span class="tag" style="background:var(--primary); color:var(--bg);">${r}</span>`).join('');
        
        const linkContainer = document.getElementById('detail-links-container');
        linkContainer.innerHTML = ''; 
        if (c.links.length > 0) {
            c.links.forEach((url, index) => {
                if(url === "#" || url === "") return;
                const btn = document.createElement('a');
                btn.href = url;
                btn.target = "_blank";
                btn.className = "external-btn";
                btn.innerText = c.links.length === 1 ? "Read Full Judgment ‚Üí" : `Read Full Judgment (Source ${index + 1}) ‚Üí`;
                linkContainer.appendChild(btn);
            });
        }
        
        // Nature Logic
        const natureContainer = document.getElementById('detail-nature-container');
        natureContainer.innerHTML = ''; // Clear previous
        if(c.nature) {
            const typeClass = c.nature.toLowerCase() === 'implicit' ? 'nature-implicit' : 'nature-explicit';
            natureContainer.innerHTML = `<span class="nature-badge ${typeClass}" style="font-size:0.7rem; margin-right:6px; padding:4px 10px;">${c.nature}</span>`;
        }

        // Contest Logic
        const contestContainer = document.getElementById('detail-contest-container');
        contestContainer.innerHTML = ''; // Clear previous
        if(c.contest) {
            const isContested = c.contest.toLowerCase() === 'contested';
            const contestClass = isContested ? 'contest-contested' : 'contest-uncontested';
            contestContainer.innerHTML = `<span class="contest-badge ${contestClass}" style="font-size:0.7rem; margin-right:6px; padding:4px 10px;">${c.contest}</span>`;
        }

        document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
        document.getElementById('details-view').style.display = 'block';
        window.scrollTo(0,0);
    }

    function closeDetails() { window.history.pushState({}, '', window.location.pathname); switchTab('tracker'); }

    function populateDropdown() {
        const rts = [...new Set(allCases.flatMap(c => c.rights))].sort();
        const sel = document.getElementById('right-filter');
        rts.forEach(r => { const o = document.createElement('option'); o.value = r; o.innerText = r; sel.appendChild(o); });
    }

    function populateStateDropdown() {
        const sel = document.getElementById('state-filter');
        sel.innerHTML = '<option value="">All Jurisdictions</option>';
        const states = [
            "Andaman and Nicobar", "Andhra Pradesh", "Arunachal Pradesh", "Assam", "Bihar", "Chandigarh", "Chhattisgarh",
            "Dadra and Nagar Haveli and Daman and Diu", "Delhi", "Goa", "Gujarat", "Haryana", "Himachal Pradesh",
            "Jammu and Kashmir", "Jharkhand", "Karnataka", "Kerala", "Ladakh", "Lakshadweep", "Madhya Pradesh",
            "Maharashtra", "Manipur", "Meghalaya", "Mizoram", "Nagaland", "Orissa", "Puducherry", "Punjab",
            "Rajasthan", "Sikkim", "Tamil Nadu", "Telangana", "Tripura", "Uttar Pradesh", "Uttarakhand", "West Bengal"
        ];
        const panOpt = document.createElement('option');
        panOpt.value = "Pan-India";
        panOpt.innerText = "Pan-India";
        sel.appendChild(panOpt);
        states.sort().forEach(s => {
            const o = document.createElement('option');
            o.value = s;
            o.innerText = s;
            sel.appendChild(o);
        });
    }

    function populateCourtDropdown() {
        const sel = document.getElementById('court-filter');
        sel.innerHTML = '<option value="">All Courts</option>';
        const courts = [
            "Supreme Court", "Allahabad High Court", "Andhra Pradesh High Court", "Bombay High Court", "Calcutta High Court",
            "Chhattisgarh High Court", "Delhi High Court", "Gauhati High Court", "Gujarat High Court", "Himachal Pradesh High Court",
            "Jammu & Kashmir and Ladakh High Court", "Jharkhand High Court", "Karnataka High Court", "Kerala High Court",
            "Madhya Pradesh High Court", "Madras High Court", "Manipur High Court", "Meghalaya High Court", "Orissa High Court",
            "Patna High Court", "Punjab & Haryana High Court", "Rajasthan High Court", "Sikkim High Court", "Telangana High Court",
            "Tripura High Court", "Uttarakhand High Court"
        ];
        courts.forEach(c => {
            const o = document.createElement('option');
            o.value = c;
            o.innerText = c;
            sel.appendChild(o);
        });
    }

    function populateJudgeDropdown() {
        const judges = [...new Set(allCases.flatMap(c => c.judges.map(cleanJudgeName)))].sort();
        const sel = document.getElementById('judge-filter');
        judges.forEach(j => {
            if(!j) return;
            const o = document.createElement('option');
            o.value = j;
            o.innerText = j;
            sel.appendChild(o);
        });
    }

    function generateHeatmap() {
        const counts = {}; let max = 0;
        let panIndiaCount = 0;
        
        allCases.forEach(c => { 
            if(c.state === "Pan-India") {
                panIndiaCount++;
            } else if(c.state) { 
                counts[c.state] = (counts[c.state] || 0) + 1; 
                if(counts[c.state] > max) max = counts[c.state]; 
            }
        });
        
        const scBtn = document.querySelector('.sc-btn');
        if(scBtn) {
            scBtn.setAttribute('data-count', panIndiaCount);
            let globalMax = max;
            if (panIndiaCount > globalMax) globalMax = panIndiaCount;
            const opacity = globalMax === 0 ? 0 : 0.15 + (0.85 * (panIndiaCount / globalMax));
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const baseColor = isDark ? [236, 240, 241] : [44, 62, 80]; 
            scBtn.style.backgroundColor = `rgba(${baseColor[0]}, ${baseColor[1]}, ${baseColor[2]}, ${opacity})`;
            if (opacity > 0.5) {
                scBtn.style.color = isDark ? '#000' : '#fff';
            } else {
                scBtn.style.color = 'var(--text)';
            }
        }

        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        const baseColor = isDark ? [236, 240, 241] : [44, 62, 80]; 

        document.querySelectorAll('#map-container path').forEach(p => {
            const n = p.getAttribute('name'); 
            const count = counts[n] || 0;
            p.setAttribute('data-count', count);
            if(count > 0) {
                const opacity = 0.15 + (0.85 * (count / max)); 
                p.style.fill = `rgba(${baseColor[0]}, ${baseColor[1]}, ${baseColor[2]}, ${opacity})`;
            } else {
                p.style.fill = ''; 
            }
        });
    }

    function checkUrlParams() {
        const params = new URLSearchParams(window.location.search);
        const caseParam = params.get('case');
        const tabParam = params.get('tab');

        if(caseParam) {
            openDetails(caseParam);
        } else if (tabParam && ['tracker', 'timeline', 'map', 'judges', 'about'].includes(tabParam)) {
            switchTab(tabParam, false); // Don't push state, we are already there
        } else {
            switchTab('tracker', false); // Default
        }
    }

    window.onpopstate = () => { 
        const params = new URLSearchParams(window.location.search);
        const caseParam = params.get('case');
        const tabParam = params.get('tab');

        if(caseParam) openDetails(caseParam);
        else if(tabParam) switchTab(tabParam, false);
        else switchTab('tracker', false);
    };
</script>

</body>
</html>
