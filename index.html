<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>PEBL | Procedure Established by Law</title>
    <meta name="description" content="Tracking the Reading of Unenumerated Rights into Article 21">
    <meta name="author" content="Abhinav Somani">

    <!-- OPEN GRAPH / SOCIAL SHARING TAGS -->
    <meta property="og:title" content="PEBL | Procedure Established by Law">
    <meta property="og:description" content="Tracking the Reading of Unenumerated Rights into Article 21">
    <meta property="og:image" content="https://pebl-tracker.github.io/social_card.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:url" content="https://pebl-tracker.github.io/">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">

    <!-- DYNAMIC FAVICON -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2250%22 fill=%22%23c0392b%22/><text x=%2250%22 y=%2275%22 font-family=%22Georgia, serif%22 font-weight=%22bold%22 font-size=%2270%22 fill=%22white%22 text-anchor=%22middle%22>P</text></svg>">

    <!-- Google Site Name Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "PEBL",
      "url": "https://pebl-tracker.github.io/"
    }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>

    <style>
        /* --- THEME VARIABLES --- */
        :root { 
            --primary: #2c3e50; --accent: #c0392b; --bg: #f8f4e9; 
            --card-bg: #ffffff; --text: #2c2c2c; --text-muted: #5a5a5a;
            --border: #e8e2d8; --tag-bg: #f0ede4; --tag-text: #4a4a4a;
            --input-bg: #ffffff; --parchment: #f2ede4;
            --banner-opacity: 0.95; --banner-filter: sepia(10%) contrast(102%);
            --map-hint-bg: rgba(255, 255, 255, 0.8);
            --timeline-line: #dcd6cc;
            --footer-bg: #e8e2d8;
        }

        [data-theme="dark"] {
            --primary: #ecf0f1; --accent: #e74c3c; --bg: #121212;
            --card-bg: #1e1e1e; --text: #e0e0e0; --text-muted: #aaaaaa;
            --border: #333333; --tag-bg: #2c3e50; --tag-text: #bdc3c7;
            --input-bg: #252525; --parchment: #1a1a1a;
            --banner-opacity: 0.5; --banner-filter: invert(90%) sepia(10%) hue-rotate(180deg) brightness(0.8);
            --map-hint-bg: rgba(30, 30, 30, 0.9);
            --timeline-line: #333;
            --footer-bg: #1a1a1a;
        }
        
        /* Gradual Transition */
        * { 
            box-sizing: border-box; 
            transition: background-color 0.6s ease, color 0.6s ease, border-color 0.6s ease; 
        }
        
        /* FIX: Forces scrollbar track to always exist, preventing layout jumps */
        html { overflow-y: scroll; }

        body { font-family: "Georgia", serif; background: var(--bg); margin: 0; padding: 0; color: var(--text); line-height: 1.6; overflow-x: hidden; display: flex; flex-direction: column; min-height: 100vh; }

        .theme-toggle { position: absolute; top: 20px; right: 20px; background: var(--card-bg); border: 1px solid var(--border); color: var(--text); padding: 6px 12px; cursor: pointer; border-radius: 4px; font-family: sans-serif; font-size: 0.75rem; font-weight: bold; z-index: 100; }

        .full-width-banner { width: 100%; height: 180px; overflow: hidden; background-color: var(--parchment); border-bottom: 1px solid var(--border); display: flex; justify-content: center; align-items: center; }
        .banner-img { max-width: 100%; height: 100%; object-fit: contain; opacity: var(--banner-opacity); filter: var(--banner-filter); }

        .container { max-width: 950px; margin: 0 auto; padding: 0 20px 60px 20px; position: relative; flex: 1; }
        
        header { margin-top: 60px; margin-bottom: 40px; text-align: center; }
        h1 { margin: 0; color: var(--primary); font-size: clamp(1.8rem, 5vw, 2.8rem); letter-spacing: -1px; font-weight: bold; }
        header a { text-decoration: none; color: inherit; }
        p.subtitle { color: var(--text-muted); font-size: 1.05rem; margin-top: 12px; font-style: italic; }

        .tab-nav { display: flex; justify-content: center; gap: 25px; margin-bottom: 40px; font-family: sans-serif; border-bottom: 1px solid var(--border); margin-top: 30px; flex-wrap: wrap; }
        .tab-btn { background: none; border: none; font-size: 0.8rem; color: #777; padding: 12px 5px; cursor: pointer; border-bottom: 2px solid transparent; font-weight: bold; letter-spacing: 1.5px; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

        /* --- TRACKER UI --- */
        .map-wrapper { position: relative; width: 100%; max-width: 850px; margin: 0 auto 40px auto; }
        svg { width: 100%; height: auto; filter: drop-shadow(0 4px 10px rgba(0,0,0,0.05)); }
        path { cursor: pointer; fill: var(--tag-bg); stroke: var(--bg); stroke-width: 0.7; }
        path:hover { fill: var(--accent) !important; }

        .sc-btn { display: block; width: fit-content; margin: 0 auto 50px auto; background: var(--accent); color: white; text-align: center; padding: 10px 25px; border-radius: 50px; text-decoration: none; font-family: sans-serif; font-size: 0.85rem; font-weight: bold; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .sc-btn:hover { transform: translateY(-2px); }

        .controls-bar { display: flex; gap: 12px; margin-bottom: 25px; background: var(--card-bg); padding: 15px; border: 1px solid var(--border); border-radius: 4px; font-family: sans-serif; flex-wrap: wrap; align-items: center; }
        #search-input { flex-grow: 2; padding: 10px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text); }
        .filter-select { flex-grow: 1; padding: 10px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text); }
        
        /* REDESIGNED DOWNLOAD BUTTON */
        .download-btn { 
            background: transparent; 
            color: var(--primary); 
            border: 1px solid var(--primary); 
            padding: 10px 20px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-weight: bold; 
            font-size: 0.8rem; 
            white-space: nowrap; 
            transition: all 0.3s ease;
        }
        .download-btn:hover { 
            background: var(--primary); 
            color: var(--bg); 
        }

        #filter-display { text-align: center; margin-bottom: 25px; min-height: 35px; }
        .filter-tag { display: inline-block; background: var(--primary); color: var(--bg); padding: 5px 15px; border-radius: 20px; font-family: sans-serif; font-size: 0.8rem; cursor: pointer; }

        /* --- VERTICAL TIMELINE --- */
        #tab-timeline { width: 100%; display: none; }
        .timeline-container { position: relative; max-width: 1000px; margin: 0 auto; padding: 40px 0; }
        .timeline-container::after { content: ''; position: absolute; width: 4px; background-color: var(--timeline-line); top: 0; bottom: 0; left: 50%; margin-left: -2px; border-radius: 2px; }
        .timeline-item { padding: 10px 40px; position: relative; background-color: inherit; width: 50%; box-sizing: border-box; }
        .timeline-item.left { left: 0; text-align: right; }
        .timeline-item.right { left: 50%; text-align: left; }
        .timeline-dot { position: absolute; width: 20px; height: 20px; right: -10px; background-color: var(--bg); border: 4px solid var(--accent); top: 25px; border-radius: 50%; z-index: 1; transition: transform 0.3s ease; }
        .timeline-item.right .timeline-dot { left: -10px; }
        .timeline-item:hover .timeline-dot { transform: scale(1.3); background-color: var(--accent); }
        .timeline-content { padding: 20px 25px; background-color: var(--card-bg); position: relative; border-radius: 6px; border: 1px solid var(--border); box-shadow: 0 4px 15px rgba(0,0,0,0.03); cursor: pointer; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .timeline-content:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0,0,0,0.08); border-color: var(--accent); }
        .t-date { font-family: sans-serif; font-weight: bold; color: var(--accent); font-size: 0.75rem; margin-bottom: 5px; display: block; letter-spacing: 1px; text-transform: uppercase; }
        .t-title { margin: 0 0 10px 0; font-size: 1.2rem; color: var(--primary); line-height: 1.3; }
        .t-summary { font-size: 0.9rem; color: var(--text-muted); margin: 0; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }

        /* --- CHAIN OF CITATION TAB --- */
        #tab-map { width: 100%; display: none; }
        .map-description { text-align: center; font-style: italic; color: var(--text-muted); margin-bottom: 20px; font-size: 0.95rem; padding: 0 20px; }
        #tab-map-container { width: 95vw; max-width: 1600px; height: 85vh; margin: 0 auto 40px auto; background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px; position: relative; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        #network-viz { width: 100%; height: 100%; cursor: grab; }
        #network-viz:active { cursor: grabbing; }
        .map-controls { position: absolute; top: 15px; left: 15px; display: flex; flex-direction: column; gap: 8px; z-index: 10; }
        .map-btn { background: var(--bg); border: 1px solid var(--border); padding: 8px 12px; font-size: 0.75rem; cursor: pointer; font-family: sans-serif; border-radius: 4px; font-weight: bold; color: var(--text); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .map-btn:hover { background: var(--tag-bg); }
        .map-hint { position: absolute; bottom: 15px; right: 15px; font-family: sans-serif; font-size: 0.7rem; color: var(--text); pointer-events: none; background: var(--map-hint-bg); padding: 6px 12px; border-radius: 4px; border: 1px solid var(--border); z-index: 10; }

        /* --- CARDS --- */
        .case-grid { display: grid; gap: 25px; }
        .card { background: var(--card-bg); padding: 30px; border: 1px solid var(--border); border-left: 5px solid var(--primary); font-family: sans-serif; }
        .card:hover { box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; }
        .card h3 { margin: 0; color: var(--primary); font-size: 1.3rem; line-height: 1.3; flex: 1; }
        .court-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; font-weight: bold; margin-left: 15px; }
        .card-date { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 10px; font-weight: bold; }
        .citation { font-family: "Georgia", serif; color: var(--text-muted); font-style: italic; display: block; margin-bottom: 15px; font-size: 0.95rem; }
        .tag { background: var(--tag-bg); padding: 4px 10px; border-radius: 3px; font-size: 0.7rem; font-weight: bold; color: #666; display: inline-block; margin-right: 6px; margin-bottom: 6px; text-transform: uppercase; }
        .summary-preview { color: var(--text); line-height: 1.6; margin-bottom: 15px; font-size: 0.95rem; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        .action-link { color: var(--primary); font-weight: bold; text-decoration: none; border-bottom: 2px solid var(--primary); cursor: pointer; font-size: 0.85rem; }

        /* --- DETAILS VIEW --- */
        #details-view { display: none; background: var(--bg); padding: 20px 0; }
        .back-btn { display: inline-block; margin-bottom: 30px; cursor: pointer; color: var(--text-muted); font-family: sans-serif; font-size: 0.8rem; font-weight: bold; letter-spacing: 1px; }
        .details-meta { border-bottom: 1px solid var(--border); padding-bottom: 20px; margin-bottom: 30px; }
        .details-body { font-size: 1.15rem; line-height: 1.8; white-space: pre-wrap; color: var(--text); }
        .external-btn { display: inline-block; margin-top: 40px; background: var(--primary); color: var(--bg); padding: 12px 25px; text-decoration: none; border-radius: 4px; font-family: sans-serif; font-weight: bold; }
        .copy-btn { background: none; border: 1px solid var(--border); color: var(--text-muted); cursor: pointer; font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; margin-left: 10px; vertical-align: middle; }
        .copy-btn:hover { background: var(--tag-bg); color: var(--primary); }

        /* --- FOOTER --- */
        footer { background-color: var(--footer-bg); padding: 40px 20px; margin-top: 60px; border-top: 1px solid var(--border); text-align: center; font-size: 0.85rem; color: var(--text-muted); }
        .footer-content { max-width: 800px; margin: 0 auto; }
        .cite-btn { background: var(--card-bg); border: 1px solid var(--border); padding: 8px 15px; border-radius: 20px; cursor: pointer; font-family: sans-serif; font-weight: bold; color: var(--primary); margin-top: 15px; display: inline-block; }
        .cite-btn:hover { background: var(--primary); color: var(--bg); }

        /* --- LOADING & SCROLL --- */
        #loading { text-align: center; color: var(--text-muted); padding: 60px; font-style: italic; }
        .loader { border: 4px solid var(--border); border-top: 4px solid var(--accent); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 15px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .scroll-top-btn { position: fixed; bottom: 30px; right: 30px; background: var(--primary); color: var(--bg); border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 100; }
        .scroll-top-btn:hover { transform: translateY(-3px); }

        /* --- MOBILE RESPONSIVENESS --- */
        @media (max-width: 600px) {
            .full-width-banner { height: auto; padding: 0; border-bottom: 1px solid var(--border); }
            .banner-img { width: 100%; height: auto; object-fit: contain; display: block; }
            header { margin-top: 0; padding-top: 50px; } 
            .card-header { flex-direction: column; }
            .court-label { margin-left: 0; margin-top: 5px; }
            .theme-toggle { top: 10px; right: 10px; }
            #tab-map-container { width: 100vw; height: 70vh; border-radius: 0; border-left: none; border-right: none; }
            .map-wrapper { max-width: 100%; }
            .timeline-container::after { left: 31px; }
            .timeline-item { width: 100%; padding-left: 70px; padding-right: 25px; }
            .timeline-item.left, .timeline-item.right { left: 0; text-align: left; }
            .timeline-dot { left: 21px !important; right: auto; }
            .controls-bar { flex-direction: column; gap: 10px; align-items: stretch; }
            #search-input, .filter-select, .download-btn { width: 100%; flex-grow: 1; }
        }
    </style>
</head>
<body>

<!-- BANNER AREA -->
<div class="full-width-banner">
    <img src="article21.png" alt="Article 21 Calligraphy" class="banner-img" onerror="this.parentElement.style.display='none'">
</div>

<div class="container">
    <button class="theme-toggle" onclick="toggleTheme()">üåì Theme</button>

    <header>
        <div class="header-content">
            <a href="."><h1>Procedure Established by Law</h1></a>
            <p class="subtitle">Tracking the Reading of Unenumerated Rights into Article 21</p>
        </div>
    </header>

    <nav class="tab-nav">
        <button id="btn-tracker" class="tab-btn active" onclick="switchTab('tracker')">TRACKER</button>
        <button id="btn-timeline" class="tab-btn" onclick="switchTab('timeline')">TIMELINE</button>
        <button id="btn-map" class="tab-btn" onclick="switchTab('map')">CHAIN OF CITATION</button>
        <button id="btn-about" class="tab-btn" onclick="switchTab('about')">ABOUT</button>
    </nav>

    <!-- TAB: TRACKER -->
    <div id="tab-tracker" class="tab-content">
        <div class="map-wrapper" id="map-container"></div>
        <div class="sc-btn" onclick="handleMapClick('Pan-India')">‚òÖ Supreme Court (Pan-India)</div>
        <div class="controls-bar">
            <input type="text" id="search-input" placeholder="Search cases or keywords..." onkeyup="handleSearch()">
            <select id="right-filter" class="filter-select" onchange="handleSearch()"><option value="">All Rights</option></select>
            <select id="sort-order" class="filter-select" onchange="handleSearch()"><option value="newest">Newest First</option><option value="oldest">Oldest First</option></select>
            <button class="download-btn" onclick="downloadData()">Download Filtered Data (CSV)</button>
        </div>
        <div id="filter-display"></div>
        <div id="loading">
            <div class="loader"></div>
            Consulting the Archives...
        </div>
        <div class="case-grid" id="case-list"></div>
    </div>

    <!-- TAB: TIMELINE (VERTICAL) -->
    <div id="tab-timeline" class="tab-content">
        <p class="map-description">
            A chronological history of the expansion of Article 21.<br>
            <span style="font-size: 0.8rem;">Format inspired by <a href="https://www.scobserver.in/journal/the-right-to-life-and-personal-liberty-under-article-21-a-timeline/" target="_blank" style="color: var(--accent); text-decoration: none;">Supreme Court Observer</a>.</span>
        </p>
        <div class="timeline-container" id="timeline-container">
            <!-- Items injected via JS -->
        </div>
    </div>

    <!-- TAB: ABOUT -->
    <div id="tab-about" class="tab-content" style="display: none;">
        <div style="max-width: 700px; margin: 0 auto;">
            <h2 style="color: var(--primary); border-bottom: 1px solid var(--border); padding-bottom: 10px;">About the Project</h2>
            <p><strong>Procedure Established by Law (PEBL)</strong> is a digital tracker auditing the expansion of Article 21 of the Constitution of India. It tracks the judicial reading of unenumerated rights into the Right to Life and Personal Liberty.</p>
            
            <h2 style="color: var(--primary); border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-top: 40px;">About the Curator</h2>
            <p>Abhinav Somani is 3rd Year B.A., LL.B. (Hons.) Student at the National Law School of India University, Bengaluru. He is deeply interested in Constitutional Interpretation, particularly vis-√†-vis Rights Provisions.</p>

            <h2 style="color: var(--primary); border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-top: 40px;">Data Source</h2>
            <p>The dataset for this project is open-source and hosted on Google Sheets. You can view the raw data here:<br>
            <a href="https://docs.google.com/spreadsheets/d/1k3O3nEbs24UXsoAsrNPmaZfBvpAJCmaEzypuQTD-yuY/edit?usp=sharing" target="_blank" style="color: var(--accent); font-weight: bold; text-decoration: none;">View Data Sheet ‚Üí</a></p>

            <h2 style="color: var(--primary); border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-top: 40px;">Map Credit</h2>
            <p>The SVG map of India is sourced from SimpleMaps:<br>
            <a href="https://simplemaps.com/svg/country/in" target="_blank" style="color: var(--accent); font-weight: bold; text-decoration: none;">SimpleMaps India SVG ‚Üí</a></p>

            <h2 style="color: var(--primary); border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-top: 40px;">Technical Architecture & Source Code</h2>
            <p>This tracker is hosted entirely on <strong>GitHub Pages</strong>. The codebase was developed with the assistance of <strong>Gemini 3 Pro and Flash</strong>, available for free via Google AI Studio.<br>
            The complete source code for this website is open-source and available on GitHub:<br>
            <a href="https://github.com/pebl-tracker/pebl-tracker.github.io" target="_blank" style="color: var(--accent); font-weight: bold; text-decoration: none;">View Repository ‚Üí</a></p>

            <h2 style="color: var(--primary); border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-top: 40px;">Contact</h2>
            <p>Reach out at: <br>
            <a href="mailto:pebl.tracker@gmail.com" style="color: var(--accent); font-weight: bold; text-decoration: none;">pebl.tracker@gmail.com</a></p>
        </div>
    </div>

    <!-- DETAILS VIEW -->
    <div id="details-view">
        <div class="back-btn" onclick="closeDetails()">‚Üê BACK TO TRACKER</div>
        <div class="details-meta">
            <h2 id="detail-title" style="margin-top:0; color: var(--primary); font-size: 2.2rem;">Case Name</h2>
            <div id="detail-citation" class="citation" style="font-size: 1.2rem;">
                <span id="raw-citation">Citation</span> 
                <button class="copy-btn" onclick="copyCaseCitation()">Copy</button>
            </div>
            <div style="margin-top: 20px;">
                <span class="tag" id="detail-court">Court</span>
                <span id="detail-rights-container"></span>
                <span class="tag" id="detail-date" style="background:var(--tag-bg);">Date</span>
            </div>
        </div>
        <div class="details-body" id="detail-summary"></div>
        <a href="#" target="_blank" class="external-btn" id="detail-link">Read Full Judgment ‚Üí</a>
    </div>
</div>

<!-- TAB: CHAIN OF CITATION (WIDE LAYOUT) -->
<div id="tab-map" class="tab-content">
    <p class="map-description">This map traces expansion of Article 21 by following the chain of precedent citations.</p>
    <div id="tab-map-container">
        <div class="map-controls">
            <button class="map-btn" onclick="zoomMap(1.2)">+</button>
            <button class="map-btn" onclick="zoomMap(0.8)">-</button>
            <button class="map-btn" onclick="resetMap()">Fit Screen</button>
            <button class="map-btn" id="physics-btn" onclick="togglePhysics()">Freeze</button>
        </div>
        <div id="network-viz"></div>
        <div class="map-hint">Scroll to Zoom ‚Ä¢ Drag to Pan ‚Ä¢ Click a Case for Details</div>
    </div>
</div>

<!-- FOOTER -->
<footer>
    <div class="footer-content">
        <p><strong>Disclaimer:</strong> The content on this tracker is for academic and informational purposes only. It does not constitute legal advice. Summaries are the curator's interpretation and should not be cited as legal authority. Please refer to the official judgment text.</p>
        <button class="cite-btn" onclick="copyArchiveCitation()">Cite This Tracker</button>
    </div>
</footer>

<!-- BACK TO TOP BUTTON -->
<button class="scroll-top-btn" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">‚Üë</button>

<script>
    // --- THEME LOGIC ---
    function toggleTheme() {
        const current = document.documentElement.getAttribute('data-theme');
        const target = current === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', target);
        localStorage.setItem('theme', target);
        generateHeatmap(); 
        if(network) initCitationMap(); 
    }

    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);

    // --- DATA LOGIC ---
    const SHEET_ID = '1k3O3nEbs24UXsoAsrNPmaZfBvpAJCmaEzypuQTD-yuY';
    const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Sheet1`;

    let allCases = [];
    let filteredCases = []; // Stores the currently visible dataset
    let currentFilterState = null;
    let network = null;
    let physicsEnabled = true;

    window.addEventListener('DOMContentLoaded', () => {
        loadMap();
        fetchData();
        
        // Scroll Listener for Back-to-Top
        window.addEventListener('scroll', () => {
            const btn = document.querySelector('.scroll-top-btn');
            if (window.scrollY > 300) btn.style.display = 'block';
            else btn.style.display = 'none';
        });
    });

    function loadMap() {
        fetch('india.svg').then(r => r.text()).then(svg => {
            document.getElementById('map-container').innerHTML = svg;
            // Inject ARIA labels automatically
            document.querySelectorAll('#map-container path').forEach(p => {
                const name = p.getAttribute('name');
                if(name) {
                    p.setAttribute('role', 'button');
                    p.setAttribute('aria-label', `View cases for ${name}`);
                }
                p.addEventListener('click', () => {
                    if(name) handleMapClick(name);
                });
            });
            generateHeatmap();
        }).catch(err => console.error("Map load failed", err));
    }

    function fetchData() {
        fetch(CSV_URL).then(r => {
            if (!r.ok) throw new Error("Network response was not ok");
            return r.text();
        }).then(csv => {
            const parsed = Papa.parse(csv, { header: false, skipEmptyLines: true });
            allCases = parsed.data.slice(1).map(row => ({
                name: (row[0] || "").trim(),
                citation: (row[1] || "").trim(),
                court: (row[2] || "").trim(),
                state: (row[3] || "Pan-India").trim(),
                rights: (row[4] || "").split(',').map(r => r.trim()).filter(r => r),
                summary: (row[5] || "").trim(),
                link: (row[6] || "#").trim(),
                date: (row[7] || "").trim(),
                cites: (row[8] || "").split(',').map(c => c.trim()).filter(c => c)
            })).filter(c => c.name && c.name !== "Case Name");

            filteredCases = allCases; // Initialize filtered list
            document.getElementById('loading').style.display = 'none';
            populateDropdown();
            generateHeatmap();
            handleSearch();
            checkUrlParams(); 
        }).catch(error => {
            document.getElementById('loading').innerHTML = `<p style="color:var(--accent); font-weight:bold;">Unable to load case data.<br>Please check your internet connection or try again later.</p>`;
            console.error("Data fetch failed:", error);
        });
    }

    // --- CITATION & EXPORT LOGIC ---
    function copyCaseCitation() {
        const text = document.getElementById('raw-citation').innerText.trim();
        navigator.clipboard.writeText(text).then(() => alert('Citation copied to clipboard!'));
    }

    function copyArchiveCitation() {
        const d = new Date();
        const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const dateStr = `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
        const citation = `Abhinav Somani, 'Procedure Established by Law' (PEBL, 2026) <https://pebl-tracker.github.io> accessed ${dateStr}.`;
        navigator.clipboard.writeText(citation).then(() => alert('Tracker citation copied to clipboard!'));
    }

    function downloadData() {
        // Use filteredCases instead of allCases
        const csv = Papa.unparse(filteredCases);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", "pebl_data.csv");
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // --- VERTICAL TIMELINE LOGIC ---
    function initTimeline() {
        const container = document.getElementById('timeline-container');
        container.innerHTML = '';
        
        const validCases = allCases.filter(c => {
            const d = parseDate(c.date);
            return d.getTime() > 0;
        }).sort((a, b) => parseDate(a.date) - parseDate(b.date));

        if(validCases.length === 0) return;

        validCases.forEach((c, index) => {
            const d = parseDate(c.date);
            const dateStr = d.toLocaleDateString('en-GB', {day:'numeric', month:'short', year:'numeric'});
            const side = index % 2 === 0 ? 'left' : 'right';
            
            const item = document.createElement('div');
            item.className = `timeline-item ${side}`;
            
            item.innerHTML = `
                <div class="timeline-dot"></div>
                <div class="timeline-content" onclick="openDetails('${encodeURIComponent(c.name)}')">
                    <span class="t-date">${dateStr} ‚Ä¢ ${c.court.toUpperCase()}</span>
                    <h3 class="t-title">${c.name}</h3>
                    <p class="t-summary">${c.summary}</p>
                </div>
            `;
            container.appendChild(item);
        });
    }

    // --- CHAIN OF CITATION LOGIC ---
    function initCitationMap() {
        const container = document.getElementById('network-viz');
        const nodes = [];
        const edges = [];
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';

        allCases.forEach((c) => {
            const year = parseDate(c.date).getFullYear();
            nodes.push({
                id: c.name,
                label: c.name.split(' v. ')[0],
                title: `${c.name}\nCourt: ${c.court}\nYear: ${year}`,
                value: 15,
                color: {
                    background: isDark ? '#2c3e50' : '#ffffff',
                    border: isDark ? '#ecf0f1' : '#2c3e50',
                    highlight: { background: '#c0392b', border: '#c0392b' }
                },
                font: { color: isDark ? '#e0e0e0' : '#2c2c2c', size: 14, face: 'Georgia' }
            });

            c.cites.forEach(citedCaseName => {
                if (allCases.some(x => x.name === citedCaseName)) {
                    edges.push({
                        from: c.name,
                        to: citedCaseName,
                        arrows: { to: { enabled: true, scaleFactor: 0.5 } },
                        color: { color: isDark ? '#555' : '#bbb', opacity: 0.8 },
                        width: 2,
                        smooth: { type: 'curvedCW', roundness: 0.2 }
                    });
                }
            });
        });

        const data = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };
        const options = {
            nodes: { shape: 'dot', scaling: { min: 10, max: 30 } },
            physics: {
                enabled: physicsEnabled,
                forceAtlas2Based: { gravitationalConstant: -250, centralGravity: 0.01, springLength: 300, springConstant: 0.05 },
                solver: 'forceAtlas2Based',
                stabilization: { iterations: 150 }
            },
            interaction: { dragNodes: true, dragView: true, zoomView: true, hover: true, tooltipDelay: 200 }
        };

        network = new vis.Network(container, data, options);
        network.on("click", (params) => {
            if (params.nodes.length > 0) openDetails(encodeURIComponent(params.nodes[0]));
        });
    }

    function zoomMap(scale) { network.moveTo({ scale: network.getScale() * scale }); }
    function resetMap() { network.fit({ animation: true }); }
    function togglePhysics() {
        physicsEnabled = !physicsEnabled;
        network.setOptions({ physics: { enabled: physicsEnabled } });
        document.getElementById('physics-btn').innerText = physicsEnabled ? "Freeze" : "Unfreeze";
    }

    // --- UI LOGIC ---
    function switchTab(t) {
        document.querySelectorAll('.tab-content, #details-view').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + t).style.display = 'block';
        document.getElementById('btn-' + t).classList.add('active');
        
        if(t === 'map') setTimeout(initCitationMap, 100);
        if(t === 'timeline') setTimeout(initTimeline, 100);
    }

    function handleSearch() {
        const query = document.getElementById('search-input').value.toLowerCase();
        const right = document.getElementById('right-filter').value;
        const sort = document.getElementById('sort-order').value;

        let filtered = currentFilterState ? allCases.filter(c => c.state === currentFilterState) : allCases;
        filtered = filtered.filter(c => (c.name.toLowerCase().includes(query) || c.summary.toLowerCase().includes(query)) && (right ? c.rights.includes(right) : true));
        
        filtered.sort((a, b) => {
            const dA = parseDate(a.date); const dB = parseDate(b.date);
            return sort === 'newest' ? dB - dA : dA - dB;
        });

        filteredCases = filtered; // Update global filtered list for CSV export
        renderCases(filtered);
    }

    function renderCases(cases) {
        const list = document.getElementById('case-list');
        list.innerHTML = cases.length ? '' : '<p style="text-align:center; color:var(--text-muted); padding: 40px;">No judgments found.</p>';
        cases.forEach(c => {
            const tags = c.rights.map(r => `<span class="tag">${r}</span>`).join('');
            let dDisp = c.date;
            try { 
                const d = parseDate(c.date); 
                if(d.getTime() > 0) dDisp = d.toLocaleDateString('en-GB', {day:'numeric', month:'short', year:'numeric'});
            } catch(e){}

            list.innerHTML += `
                <div class="card">
                    <div class="card-header"><h3>${c.name}</h3><span class="court-label">${c.court}</span></div>
                    <div class="card-date">${dDisp}</div>
                    <span class="citation">${c.citation}</span>
                    <div>${tags}</div>
                    <div class="summary-preview">${c.summary}</div>
                    <a class="action-link" onclick="openDetails('${encodeURIComponent(c.name)}')">READ MORE ‚Üí</a>
                </div>`;
        });
    }

    function parseDate(s) {
        if(!s) return new Date(0);
        const p = s.split(/[-/.]/);
        return p.length === 3 ? new Date(p[2], p[1]-1, p[0]) : (p.length === 1 ? new Date(p[0],0,1) : new Date(s));
    }

    function handleMapClick(n) {
        switchTab('tracker');
        currentFilterState = n;
        document.getElementById('filter-display').innerHTML = `<span class="filter-tag" onclick="resetFilter()">Jurisdiction: ${n} ‚úï</span>`;
        handleSearch();
        document.getElementById('search-input').scrollIntoView({behavior: "smooth", block: "start"});
    }

    function resetFilter() { currentFilterState = null; document.getElementById('filter-display').innerHTML = ''; handleSearch(); }

    function openDetails(enc) {
        const c = allCases.find(x => x.name === decodeURIComponent(enc));
        if(!c) return;
        window.history.pushState({}, '', '?case=' + enc);
        document.getElementById('detail-title').innerText = c.name;
        // Separate the raw citation text from the button
        document.getElementById('detail-citation').innerHTML = `<span id="raw-citation">${c.citation}</span> <button class="copy-btn" onclick="copyCaseCitation()">Copy</button>`;
        document.getElementById('detail-court').innerText = c.court;
        document.getElementById('detail-date').innerText = c.date;
        document.getElementById('detail-summary').innerText = c.summary;
        document.getElementById('detail-link').href = c.link;
        document.getElementById('detail-rights-container').innerHTML = c.rights.map(r => `<span class="tag" style="background:var(--primary); color:var(--bg);">${r}</span>`).join('');
        document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
        document.getElementById('details-view').style.display = 'block';
        window.scrollTo(0,0);
    }

    function closeDetails() { window.history.pushState({}, '', window.location.pathname); switchTab('tracker'); }

    function populateDropdown() {
        const rts = [...new Set(allCases.flatMap(c => c.rights))].sort();
        const sel = document.getElementById('right-filter');
        rts.forEach(r => { const o = document.createElement('option'); o.value = r; o.innerText = r; sel.appendChild(o); });
    }

    function generateHeatmap() {
        const counts = {}; let max = 0;
        allCases.forEach(c => { if(c.state && c.state !== "Pan-India") { counts[c.state] = (counts[c.state] || 0) + 1; if(counts[c.state] > max) max = counts[c.state]; }});
        
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        const baseColor = isDark ? [236, 240, 241] : [44, 62, 80]; 

        document.querySelectorAll('#map-container path').forEach(p => {
            const n = p.getAttribute('name'); const count = counts[n] || 0;
            if(count > 0) {
                const opacity = 0.15 + (0.85 * (count / max));
                p.style.fill = `rgba(${baseColor[0]}, ${baseColor[1]}, ${baseColor[2]}, ${opacity})`;
            } else {
                p.style.fill = ''; 
            }
        });
    }

    function checkUrlParams() {
        const p = new URLSearchParams(window.location.search).get('case');
        if(p) openDetails(p); else handleSearch();
    }

    window.onpopstate = () => { const p = new URLSearchParams(window.location.search).get('case'); if(p) openDetails(p); else closeDetails(); };
</script>

</body>
</html>
